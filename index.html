<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heritage Tree • Family Explorer</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Modern Color Palette */
            --bark-900: #1a1a1a;      /* Deep charcoal */
            --bark-800: #2d2d2d;      /* Charcoal */
            --bark-700: #3d3d3d;      /* Medium charcoal */
            --gold-500: #f4a261;      /* Warm coral-gold */
            --gold-400: #f6b888;      /* Light coral */
            --gold-300: #ffd4a3;      /* Pale coral */
            --sage-500: #6c9a8b;      /* Sage green */
            --sage-400: #a8c5b5;      /* Light sage */
            --rose-500: #ff6b9d;      /* Bright pink for female */
            --rose-400: #ffb3cc;      /* Light pink */
            --cream: #f5f5f5;         /* Off-white */
            --parchment: #e8e8e8;     /* Light gray */
            --blue-500: #4a9eff;      /* Bright blue for male */
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(165deg, var(--bark-900) 0%, var(--bark-800) 50%, #252525 100%);
            min-height: 100vh;
            color: var(--cream);
            overflow-x: hidden;
            position: relative;
            font-size: 16px;
            line-height: 1.6;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                repeating-linear-gradient(90deg, transparent, transparent 8px, rgba(212, 175, 55, 0.05) 8px, rgba(212, 175, 55, 0.05) 10px),
                repeating-linear-gradient(0deg, transparent, transparent 8px, rgba(212, 175, 55, 0.05) 8px, rgba(212, 175, 55, 0.05) 10px);
            background-size: 80px 80px;
            opacity: 0.6;
            pointer-events: none;
            z-index: 0;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='150' height='150' xmlns='http://www.w3.org/2000/svg'%3E%3Cg opacity='0.15' fill='none' stroke='%23d4af37' stroke-width='2'%3E%3Ccircle cx='75' cy='30' r='6'/%3E%3Ccircle cx='50' cy='80' r='5'/%3E%3Ccircle cx='100' cy='80' r='5'/%3E%3Ccircle cx='35' cy='120' r='4'/%3E%3Ccircle cx='65' cy='120' r='4'/%3E%3Ccircle cx='85' cy='120' r='4'/%3E%3Ccircle cx='115' cy='120' r='4'/%3E%3Cline x1='75' y1='36' x2='75' y2='60'/%3E%3Cline x1='75' y1='60' x2='50' y2='75'/%3E%3Cline x1='75' y1='60' x2='100' y2='75'/%3E%3Cline x1='50' y1='85' x2='35' y2='115'/%3E%3Cline x1='50' y1='85' x2='65' y2='115'/%3E%3Cline x1='100' y1='85' x2='85' y2='115'/%3E%3Cline x1='100' y1='85' x2='115' y2='115'/%3E%3C/g%3E%3C/svg%3E");
            background-size: 150px 150px;
            background-repeat: repeat;
            opacity: 0.5;
            pointer-events: none;
            z-index: 0;
        }
        
        .app { display: flex; height: 100vh; position: relative; z-index: 1; }
        
        .sidebar {
            width: 380px;
            background: linear-gradient(180deg, rgba(42, 40, 28, 0.95) 0%, rgba(29, 27, 19, 0.98) 100%);
            border-right: 1px solid rgba(212, 175, 55, 0.2);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(20px);
            box-shadow: 4px 0 30px rgba(0, 0, 0, 0.5);
        }
        
        .sidebar-header {
            padding: 24px 20px 16px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.15);
            background: linear-gradient(to bottom, rgba(212, 175, 55, 0.05), transparent);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .sidebar-toggle-inside {
            position: static !important;
            margin: 0 !important;
            flex-shrink: 0;
        }
        
        .sidebar-title-group {
            flex: 1;
        }
        
        .app-title {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 26px;
            font-weight: 700;
            color: var(--gold-500);
            margin-bottom: 4px;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
        }
        
        .app-subtitle {
            font-size: 12px;
            color: var(--gold-300);
            opacity: 0.8;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .search-section {
            padding: 16px 20px; /* Reduced padding */
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
            flex-shrink: 0; /* Don't shrink */
        }
        
        .search-box input {
            width: 100%;
            padding: 14px 20px;
            background: rgba(248, 246, 240, 0.08);
            border: 1px solid rgba(212, 175, 55, 0.25);
            border-radius: 8px;
            font-family: 'Crimson Text', serif;
            font-size: 16px;
            color: var(--cream);
            transition: all 0.3s ease;
        }
        
        .search-box input::placeholder { color: var(--gold-300); opacity: 0.5; }
        .search-box input:focus {
            outline: none;
            background: rgba(248, 246, 240, 0.12);
            border-color: var(--gold-400);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .filters { margin-top: 16px; display: flex; gap: 12px; }
        .filters select {
            flex: 1;
            padding: 10px 14px;
            background: rgba(248, 246, 240, 0.08);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 6px;
            color: var(--gold-300);
            font-family: 'Crimson Text', serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .filters select:focus { outline: none; border-color: var(--gold-400); }
        
        
        .sidebar-controls {
            padding: 12px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.15);
            background: rgba(0, 0, 0, 0.2);
            display: grid;
            grid-template-columns: 1fr; /* Single column instead of 2 */
            gap: 6px;
            flex-shrink: 0; /* Don't shrink */
        }
        
        .sidebar-controls .control-btn {
            width: 100%;
            padding: 8px 10px; /* Smaller padding */
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.08));
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: var(--gold-400);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px; /* Smaller font */
            font-weight: 600;
            text-align: center;
        }
        
        .sidebar-controls .control-btn:hover {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.25), rgba(212, 175, 55, 0.15));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }
        
        .sidebar-controls .control-btn:active {
            transform: translateY(0);
        }
        
        .person-list-container {
            flex: 1 1 auto; /* Grow and shrink, auto basis */
            overflow-y: scroll; /* Always show scrollbar area */
            overflow-x: hidden;
            padding: 20px 32px;
            -webkit-overflow-scrolling: touch; /* Smooth iOS scrolling */
            overscroll-behavior: contain; /* Prevent scroll chaining */
            /* Approximate: 100vh - header(~80px) - controls(~200px) - search(~120px) */
            height: calc(100vh - 400px);
            min-height: 200px;
        }
        
        .person-item {
            background: linear-gradient(135deg, rgba(248, 246, 240, 0.06) 0%, rgba(212, 175, 55, 0.03) 100%);
            border: 1px solid rgba(212, 175, 55, 0.15);
            border-radius: 10px;
            padding: 16px 18px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .person-item::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 4px;
            height: 100%;
            background: var(--gold-400);
            transform: scaleY(0);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .person-item:hover {
            background: linear-gradient(135deg, rgba(248, 246, 240, 0.12) 0%, rgba(212, 175, 55, 0.08) 100%);
            border-color: var(--gold-400);
            transform: translateX(4px);
        }
        .person-item:hover::before { transform: scaleY(1); }
        
        .person-item.selected {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(212, 175, 55, 0.08) 100%);
            border-color: var(--gold-400);
            box-shadow: 0 4px 16px rgba(212, 175, 55, 0.2);
        }
        .person-item.selected::before { transform: scaleY(1); }
        
        .person-name-list {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--gold-300);
            margin-bottom: 6px;
        }
        
        .person-meta {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 13px;
            color: var(--parchment);
            opacity: 0.7;
        }
        
        .badge-sm {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-sm.male {
            background: rgba(74, 158, 255, 0.2);
            color: var(--blue-500);
            border: 1px solid rgba(74, 158, 255, 0.4);
            font-weight: 600;
        }
        
        .badge-sm.female {
            background: rgba(255, 107, 157, 0.2);
            color: var(--rose-500);
            border: 1px solid rgba(255, 107, 157, 0.4);
            font-weight: 600;
        }
        
        .tree-canvas {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            background: radial-gradient(circle at 50% 50%, rgba(212, 175, 55, 0.02) 0%, transparent 60%),
                        repeating-linear-gradient(0deg, transparent, transparent 49px, rgba(212, 175, 55, 0.03) 49px, rgba(212, 175, 55, 0.03) 50px);
        }
        
        /* Main Search Bar */
        .main-search-bar {
            padding: 15px 20px;
            background: linear-gradient(135deg, var(--bark-800) 0%, var(--bark-900) 100%);
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            flex-shrink: 0;
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .main-search-bar .mobile-sidebar-toggle {
            position: static;
            margin: 0;
            flex-shrink: 0;
        }
        
        .main-search-bar input {
            flex: 1;
            max-width: 500px;
            padding: 12px 20px;
            background: rgba(248, 246, 240, 0.08);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 25px;
            color: var(--parchment);
            font-size: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: all 0.3s;
            position: relative;
            z-index: 10;
        }
        
        .main-search-bar input:focus {
            outline: none;
            border-color: var(--gold-500);
            background: rgba(248, 246, 240, 0.12);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
        }
        
        .main-search-bar input::placeholder {
            color: var(--parchment);
            opacity: 0.5;
        }
        
        .version-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: var(--gold-400);
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
            border: 1px solid var(--gold-400);
            font-family: monospace;
        }
        
        .tree-viewport {
            flex: 1;
            position: relative;
            width: 100%;
            overflow: auto;
            overflow-x: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            touch-action: pan-x pan-y; /* Allow touch panning */
        }
        
        .tree-scroll-content {
            min-width: max-content;
            min-height: max-content;
            padding: 20px 15px 20px 5px;
            display: inline-block;
            transform-origin: top left;
            transition: transform 0.3s ease;
        }
        
        .tree-root {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            animation: fadeInTree 0.8s ease-out;
            margin: 0 auto;
        }
        
        @keyframes fadeInTree {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .tree-node {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
            position: relative;
        }
        
        /* Vertical line UP from blood relative to horizontal bar */
        .tree-node.has-blood-parent::after {
            content: '';
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 40px;
            background: linear-gradient(to bottom, var(--gold-400), var(--gold-500));
            box-shadow: 0 0 8px rgba(212, 175, 55, 0.4);
            z-index: 1;
        }
        
        /* For spouse pairs with blood on left, offset line to left card center */
        .tree-node.blood-on-left.has-blood-parent::after {
            left: calc(50% - 135px);
        }
        
        /* For spouse pairs with blood on right, offset line to right card center */
        .tree-node.blood-on-right.has-blood-parent::after {
            left: calc(50% + 135px);
        }
        
        .node-card {
            background: linear-gradient(135deg, rgba(248, 246, 240, 0.12) 0%, rgba(212, 175, 55, 0.05) 100%);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            padding: 0;
            min-width: 240px;
            max-width: 400px;
            width: auto;
            height: 70px;
            text-align: left;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: row;
            align-items: stretch;
            gap: 0;
            overflow: hidden;
        }
        
        /* Male color scheme - blueish */
        .node-card.male {
            background: linear-gradient(135deg, rgba(93, 173, 226, 0.15) 0%, rgba(52, 152, 219, 0.08) 100%);
            border-left: 4px solid rgba(52, 152, 219, 0.6);
            border-color: rgba(52, 152, 219, 0.4);
        }
        
        /* Female color scheme - pinkish */
        .node-card.female {
            background: linear-gradient(135deg, rgba(236, 112, 140, 0.15) 0%, rgba(219, 69, 117, 0.08) 100%);
            border-left: 4px solid rgba(219, 69, 117, 0.6);
            border-color: rgba(219, 69, 117, 0.4);
        }
        
        .node-image {
            width: 70px;
            height: 100%;
            border-radius: 10px 0 0 10px;
            object-fit: cover;
            margin: 0;
            border: none;
            box-shadow: none;
            flex-shrink: 0;
        }
        
        .node-card::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(135deg, var(--gold-400), var(--gold-500));
            border-radius: 12px;
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: -1;
        }
        
        .node-card:hover {
            transform: translateY(-4px) scale(1.03);
            border-color: var(--gold-400);
            box-shadow: 0 12px 32px rgba(212, 175, 55, 0.4), 0 0 60px rgba(212, 175, 55, 0.15);
        }
        .node-card:hover::before { opacity: 0.2; }
        
        .node-card.selected {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(212, 175, 55, 0.1) 100%);
            border-color: var(--gold-400);
            box-shadow: 0 12px 40px rgba(212, 175, 55, 0.5), 0 0 80px rgba(212, 175, 55, 0.2);
            transform: scale(1.05);
        }
        .node-card.selected::before { opacity: 0.3; }
        
        .node-card.male { border-left: 4px solid var(--sage-500); }
        .node-card.female { border-left: 4px solid var(--rose-500); }
        
        /* Content wrapper - allows text to wrap and grow */
        .node-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 4px;
            padding: 8px 12px;
        }
        
        .node-name {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--gold-300);
            margin-bottom: 0;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            line-height: 1.3;
            /* Allow wrapping to multiple lines */
            white-space: normal;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }
        
        .node-dates {
            font-size: 12px;
            color: var(--parchment);
            opacity: 0.8;
            margin: 0;
            line-height: 1.2;
        }
        
        .node-badges {
            display: none; /* Hidden by default */
            gap: 6px;
            justify-content: center;
            margin-top: 6px;
        }
        
        /* Show badges in debug mode */
        body.debug-mode .node-badges {
            display: flex;
        }
        
        .node-badge {
            padding: 4px 12px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        
        .node-badge.male {
            background: rgba(90, 111, 78, 0.3);
            color: var(--sage-400);
            border: 1px solid rgba(90, 111, 78, 0.5);
        }
        
        .node-badge.female {
            background: rgba(160, 88, 88, 0.3);
            color: var(--rose-400);
            border: 1px solid rgba(160, 88, 88, 0.5);
        }
        
        .node-badge.gen {
            background: rgba(212, 175, 55, 0.2);
            color: var(--gold-400);
            border: 1px solid rgba(212, 175, 55, 0.4);
        }
        
        .node-badge.blood-relative {
            background: rgba(52, 152, 219, 0.2);
            color: #5dade2;
            border: 1px solid rgba(52, 152, 219, 0.4);
        }
        
        .node-badge.married-in {
            background: rgba(155, 89, 182, 0.2);
            color: #bb8fce;
            border: 1px solid rgba(155, 89, 182, 0.4);
        }
        
        .tree-children {
            display: flex;
            gap: 40px;
            margin-top: 60px;
            position: relative;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* Vertical line down from parent to horizontal bar */
        .tree-children::before {
            content: '';
            position: absolute;
            top: -145px; /* Changed from -140px to -145px (shifted up by 5px more) */
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 125px; /* Increased from 120px to 125px */
            background: linear-gradient(to bottom, var(--gold-500), var(--gold-400));
            box-shadow: 0 0 8px rgba(212, 175, 55, 0.4);
            z-index: 1;
        }
        
        /* Horizontal connector bar across all siblings */
        .tree-children::after {
            content: '';
            position: absolute;
            top: -20px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gold-400);
            box-shadow: 0 0 8px rgba(212, 175, 55, 0.3);
            z-index: 0;
        }
        
        /* Junction control with 4-directional toggles */
        /* Direction toggle buttons positioned on card edges */
        .direction-toggle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--gold-400), var(--gold-500));
            border: 2px solid var(--bark-800);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            color: var(--bark-900);
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            z-index: 15;
        }
        
        .direction-toggle:hover {
            transform: scale(1.3);
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.8);
        }
        
        .direction-toggle.disabled {
            background: linear-gradient(135deg, #555, #333);
            opacity: 0.5;
        }
        
        /* Position buttons on card edges */
        .direction-toggle.top {
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .direction-toggle.top:hover {
            transform: translateX(-50%) scale(1.3);
        }
        
        .direction-toggle.bottom {
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .direction-toggle.bottom:hover {
            transform: translateX(-50%) scale(1.3);
        }
        
        .direction-toggle.left {
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .direction-toggle.left:hover {
            transform: translateY(-50%) scale(1.3);
        }
        
        .direction-toggle.right {
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .direction-toggle.right:hover {
            transform: translateY(-50%) scale(1.3);
        }
        
        .spouse-pair {
            display: flex;
            gap: 0px; /* Removed gap to bring cards right up to the connector */
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .spouse-connector {
            width: 30px; /* Restored to 30px */
            height: 3px;
            background: linear-gradient(to right, #e74c3c, #c0392b);
            position: relative;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
            border-radius: 2px;
        }
        
        /* Toggle button on spouse connector to hide children */
        .spouse-connector-toggle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--gold-400), var(--gold-500));
            border: 2px solid var(--bark-800);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            color: var(--bark-900);
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            z-index: 20;
        }
        
        .spouse-connector-toggle:hover {
            transform: translate(-50%, -50%) scale(1.3);
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.8);
        }
        
        .spouse-connector-toggle.disabled {
            background: linear-gradient(135deg, #555, #333);
            opacity: 0.5;
        }
        
        .spouse-connector::before,
        .spouse-connector::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e74c3c;
            transform: translateY(-50%);
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.6);
        }
        
        .spouse-connector::before {
            left: -4px;
        }
        
        .spouse-connector::after {
            right: -4px;
        }
        
        /* Heart symbol in the middle of spouse connector */
        .spouse-pair::after {
            content: '♥';
            position: absolute;
            left: -22px; /* Aligned with toggle button */
            top: 50%;
            transform: translateY(calc(-50% + 15px)); /* Move down below toggle */
            color: var(--gold-500);
            font-size: 16px;
            z-index: 5;
            pointer-events: none;
        }
        
        .controls-bar {
            position: absolute;
            top: 24px;
            right: 24px;
            display: flex;
            gap: 12px;
            z-index: 10;
        }
        
        .zoom-controls {
            position: absolute;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
        }
        
        .zoom-btn {
            background: rgba(42, 40, 28, 0.95);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            width: 48px;
            height: 48px;
            color: var(--gold-300);
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .zoom-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--gold-400);
            color: var(--gold-400);
            transform: scale(1.05);
        }
        
        .zoom-level {
            background: rgba(42, 40, 28, 0.95);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--gold-300);
            font-size: 13px;
            text-align: center;
            backdrop-filter: blur(10px);
            font-family: 'Crimson Text', serif;
        }
        
        .control-btn {
            background: rgba(42, 40, 28, 0.9);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 10px 20px;
            color: var(--gold-300);
            font-family: 'Crimson Text', serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .control-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--gold-400);
            color: var(--gold-400);
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: var(--gold-300);
            opacity: 0.6;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-state-text {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .relationship-panel {
            position: absolute;
            top: 80px;
            right: 24px;
            width: 400px;
            background: linear-gradient(180deg, rgba(42, 40, 28, 0.98) 0%, rgba(29, 27, 19, 0.98) 100%);
            border: 2px solid rgba(212, 175, 55, 0.4);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            z-index: 100;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .relationship-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .relationship-header h3 {
            font-family: 'Playfair Display', serif;
            font-size: 22px;
            color: var(--gold-400);
            font-weight: 700;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--gold-300);
            font-size: 24px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            color: var(--gold-400);
        }
        
        .relationship-content {
            padding: 20px 24px;
        }
        
        .relationship-instruction {
            font-size: 14px;
            color: var(--gold-300);
            margin-bottom: 16px;
            text-align: center;
            opacity: 0.8;
        }
        
        .selected-people {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .selected-person-box {
            background: rgba(212, 175, 55, 0.08);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
        }
        
        .selected-person-box label {
            font-size: 12px;
            color: var(--gold-300);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
            margin-bottom: 6px;
        }
        
        .selected-person-box div {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            color: var(--cream);
            font-weight: 600;
        }
        
        .relationship-result {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(212, 175, 55, 0.08) 100%);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 10px;
            padding: 16px;
            min-height: 80px;
            display: none;
        }
        
        .relationship-result.show {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .relationship-type {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            color: var(--gold-400);
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .relationship-path {
            font-size: 14px;
            color: var(--cream);
            line-height: 1.6;
        }
        
        .relationship-path-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
        }
        
        .relationship-path-item::before {
            content: '→';
            color: var(--gold-400);
            margin-right: 8px;
            font-weight: bold;
        }
        
        .control-btn.active {
            background: rgba(212, 175, 55, 0.3);
            border-color: var(--gold-400);
            color: var(--gold-400);
        }
        
        .node-card.relationship-highlight {
            border-color: #e67e22;
            box-shadow: 0 8px 24px rgba(230, 126, 34, 0.5);
        }
        
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: rgba(26, 15, 10, 0.5); }
        ::-webkit-scrollbar-thumb { background: rgba(212, 175, 55, 0.3); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(212, 175, 55, 0.5); }
        
        /* Collapsible Sidebar - ALL DEVICES */
        .sidebar {
            position: fixed;
            left: -100%;
            top: 0;
            height: 100vh;
            width: 380px;
            max-width: 85vw;
            z-index: 99999; /* Very high - always on top */
            transition: left 0.3s ease;
            overflow: hidden; /* Don't scroll sidebar itself */
            pointer-events: auto;
            background: linear-gradient(180deg, rgba(42, 40, 28, 0.98) 0%, rgba(29, 27, 19, 1) 100%);
            box-shadow: 4px 0 30px rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
        }
        
        .sidebar.mobile-open {
            left: 0;
        }
        
        .mobile-sidebar-toggle {
            display: block;
            position: fixed;
            top: 75px;
            left: 15px;
            z-index: 100000;
            background: linear-gradient(135deg, var(--gold-400), var(--gold-500));
            color: var(--bark-900);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            transition: all 0.3s;
            pointer-events: auto;
        }
        
        .mobile-sidebar-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(212, 175, 55, 0.6);
        }
        
        .mobile-sidebar-toggle:active {
            transform: scale(0.95);
        }
        
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 380px; /* Start AFTER sidebar width */
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 99998; /* Below sidebar but above tree */
            pointer-events: auto;
        }
        
        .mobile-overlay.active {
            display: block;
        }
        
        /* On smaller screens, overlay starts after actual sidebar width */
        @media (max-width: 768px) {
            .mobile-overlay {
                left: 320px;
            }
        }
        
        @media (max-width: 480px) {
            .mobile-overlay {
                left: 280px;
            }
        }
        
        /* Block tree interaction when sidebar is open */
        .tree-canvas {
            pointer-events: auto;
            position: relative;
        }
        
        body.sidebar-open .tree-canvas {
            pointer-events: none; /* Disable tree interaction when sidebar is open */
            touch-action: none; /* Block touch on tree */
            user-select: none; /* Prevent text selection */
        }
        
        body.sidebar-open .tree-canvas * {
            pointer-events: none !important; /* Disable all children too */
        }
        
        /* Tree canvas takes full width when sidebar is hidden */
        .tree-canvas {
            width: 100%;
            margin-left: 0;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .sidebar {
                width: 320px;
            }
            
            .sidebar-controls {
                grid-template-columns: 1fr;
            }
            
            .zoom-controls {
                right: 10px;
                bottom: 70px;
            }
            
            /* MOBILE VERTICAL TREE LAYOUT */
            
            .tree-node {
                display: block;
                margin: 0;
                padding: 0;
                width: 100%;
            }
            
            /* Remove margin-based indents - tree-node stays aligned left */
            .tree-node[data-generation="0"],
            .tree-node[data-generation="1"],
            .tree-node[data-generation="2"],
            .tree-node[data-generation="3"],
            .tree-node[data-generation="4"],
            .tree-node[data-generation="5"],
            .tree-node[data-generation="6"],
            .tree-node[data-generation="7"] { 
                margin-left: 0;
            }
            
            /* Indent based on generation using padding on the content */
            .tree-node[data-generation="0"] .spouse-pair,
            .tree-node[data-generation="0"] .single-person { padding-left: 0; }
            
            .tree-node[data-generation="1"] .spouse-pair,
            .tree-node[data-generation="1"] .single-person { padding-left: 20px; }
            
            .tree-node[data-generation="2"] .spouse-pair,
            .tree-node[data-generation="2"] .single-person { padding-left: 40px; }
            
            .tree-node[data-generation="3"] .spouse-pair,
            .tree-node[data-generation="3"] .single-person { padding-left: 60px; }
            
            .tree-node[data-generation="4"] .spouse-pair,
            .tree-node[data-generation="4"] .single-person { padding-left: 80px; }
            
            .tree-node[data-generation="5"] .spouse-pair,
            .tree-node[data-generation="5"] .single-person { padding-left: 100px; }
            
            .tree-node[data-generation="6"] .spouse-pair,
            .tree-node[data-generation="6"] .single-person { padding-left: 120px; }
            
            .tree-node[data-generation="7"] .spouse-pair,
            .tree-node[data-generation="7"] .single-person { padding-left: 140px; }
            
            /* Spouse pair container */
            .spouse-pair {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
                align-items: flex-start;
                position: relative;
            }
            
            /* Heart symbol next to toggle on the left line for spouse pairs */
            
            
            /* Single person container */
            .single-person {
                margin-bottom: 15px;
            }
            
            /* Hide all connecting lines on mobile */
            .tree-node::before,
            .tree-node::after,
            .node-card::before,
            .spouse-connector,
            .horizontal-bar {
                display: none !important;
            }
            
            /* Vertical connector from parent */
            .has-parent-line::before {
                content: '';
                position: absolute;
                left: -10px;
                top: 50%;
                width: 10px;
                height: 2px;
                background: var(--gold-500);
                display: block !important;
            }
            
            /* Card adjustments for mobile vertical */
            .node-card {
                margin: 0;
                position: relative;
            }
            
            /* Children container */
            .children-container {
                display: block;
                margin-top: 10px;
            }
        }
        
        /* Extra small mobile */
        @media (max-width: 480px) {
            .sidebar {
                width: 280px;
            }
            
            .mobile-sidebar-toggle {
                width: 45px;
                height: 45px;
                font-size: 20px;
                top: 10px;
                left: 10px;
            }
        }
        
            .node-card {
                width: 200px;
                min-height: 60px;
            }
            
            .node-name {
                font-size: 16px;
                margin-bottom: 4px;
            }
            
            .node-dates {
                font-size: 12px;
                margin-bottom: 4px;
            }
            
            
            .spouse-connector {
                width: 25px;
            }
            
            .direction-toggle {
                width: 18px;
                height: 18px;
                font-size: 12px;
            }
            
            .control-btn {
                font-size: 11px;
                padding: 6px 10px;
            }
            
            .tree-canvas {
                font-size: 14px;
            }
        }
        
        
        /* Data Manager Modal */
        .data-manager-modal {
            display: none !important; /* Force hidden */
            visibility: hidden !important; /* Double hidden */
            opacity: 0 !important; /* Triple hidden */
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200000; /* Way above sidebar and everything else */
            overflow: auto;
            pointer-events: none; /* Can't interact when hidden */
        }
        
        .data-manager-modal.active {
            display: flex !important; /* Override when active */
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto; /* Can interact when active */
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
        }
        
        .data-manager-content {
            background: linear-gradient(135deg, var(--bark-900), var(--bark-800));
            border: 2px solid var(--gold-400);
            border-radius: 16px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            margin-top: 20px;
        }
        
        .data-manager-header {
            background: linear-gradient(135deg, var(--gold-500), var(--gold-600));
            padding: 20px 30px;
            border-bottom: 2px solid var(--gold-400);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .data-manager-header h2 {
            margin: 0;
            color: var(--bark-900);
            font-size: 24px;
        }
        
        .data-manager-close {
            background: var(--bark-900);
            color: var(--gold-400);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .data-manager-close:hover {
            transform: scale(1.1);
            background: var(--bark-800);
        }
        
        .data-manager-body {
            padding: 30px;
        }
        
        .data-manager-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--gold-400);
        }
        
        .data-tab {
            padding: 12px 24px;
            background: transparent;
            color: var(--gold-300);
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .data-tab:hover {
            color: var(--gold-400);
        }
        
        .data-tab.active {
            color: var(--gold-500);
            border-bottom-color: var(--gold-500);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .data-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--gold-400), var(--gold-500));
            color: var(--bark-900);
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }
        
        .action-btn.secondary {
            background: linear-gradient(135deg, var(--bark-700), var(--bark-600));
            color: var(--gold-400);
        }
        
        .people-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .person-item {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05));
            border: 2px solid var(--gold-400);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .person-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(212, 175, 55, 0.3);
            border-color: var(--gold-500);
        }
        
        .person-item.selected {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(212, 175, 55, 0.2));
            border-color: var(--gold-500);
        }
        
        .person-item-name {
            font-weight: bold;
            color: var(--gold-400);
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .person-item-details {
            font-size: 13px;
            color: var(--gold-200);
            opacity: 0.8;
        }
        
        .edit-form {
            background: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            color: var(--gold-400);
            font-weight: bold;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select {
            padding: 10px 15px;
            background: var(--bark-800);
            border: 2px solid var(--gold-400);
            border-radius: 6px;
            color: var(--gold-200);
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--gold-500);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: flex-end;
        }
        
        .import-export-area {
            background: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 8px;
        }
        
        .import-export-area h3 {
            color: var(--gold-400);
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            background: var(--bark-800);
            border: 2px solid var(--gold-400);
            border-radius: 6px;
            color: var(--gold-200);
            font-family: monospace;
            font-size: 13px;
            resize: vertical;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--gold-500);
        }
        
        /* Theme Selector Styles */
        .theme-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* ===== VERTICAL TREE LAYOUT - APPLIES TO ALL SCREEN SIZES ===== */
        
        .tree-node {
            display: block;
            margin: 0;
            padding: 0;
            width: 100%;
        }
        
        /* Remove margin-based indents - tree-node stays aligned left */
        .tree-node[data-generation="0"],
        .tree-node[data-generation="1"],
        .tree-node[data-generation="2"],
        .tree-node[data-generation="3"],
        .tree-node[data-generation="4"],
        .tree-node[data-generation="5"],
        .tree-node[data-generation="6"],
        .tree-node[data-generation="7"] { 
            margin-left: 0;
        }
        
        /* Indent based on generation using padding on the content */
        .tree-node[data-generation="0"] .spouse-pair,
        .tree-node[data-generation="0"] .single-person { padding-left: 0; }
        
        /* Fix toggle position for generation 0 - ensure it's centered on the card */
        .tree-node[data-generation="0"] .fold-toggle {
            top: 35px; /* Fixed position to match 70px card height */
        }
        
        .tree-node[data-generation="1"] .spouse-pair,
        .tree-node[data-generation="1"] .single-person { padding-left: 20px; }
        
        .tree-node[data-generation="2"] .spouse-pair,
        .tree-node[data-generation="2"] .single-person { padding-left: 40px; }
        
        .tree-node[data-generation="3"] .spouse-pair,
        .tree-node[data-generation="3"] .single-person { padding-left: 60px; }
        
        .tree-node[data-generation="4"] .spouse-pair,
        .tree-node[data-generation="4"] .single-person { padding-left: 80px; }
        
        .tree-node[data-generation="5"] .spouse-pair,
        .tree-node[data-generation="5"] .single-person { padding-left: 100px; }
        
        .tree-node[data-generation="6"] .spouse-pair,
        .tree-node[data-generation="6"] .single-person { padding-left: 120px; }
        
        .tree-node[data-generation="7"] .spouse-pair,
        .tree-node[data-generation="7"] .single-person { padding-left: 140px; }
        
        /* Spouse pair container */
        .spouse-pair {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: flex-start;
            position: relative;
        }
        
        /* Heart symbol below toggle on the left line for spouse pairs */
        .spouse-pair::after {
            content: '♥';
            position: absolute;
            left: -13px; /* Align with toggle CENTER (-22px + 9px = -13px, center of 18px toggle) */
            top: calc(50% + 22px); /* Move down from center */
            transform: translateX(-50%); /* Center horizontally only */
            color: var(--gold-500);
            font-size: 16px;
            z-index: 5;
            pointer-events: none;
        }
        
        /* Hide heart on root-level spouse pairs */
        .tree-root > .spouse-pair::after {
            display: none;
        }
        
        /* Single person container */
        .single-person {
            margin-bottom: 15px;
        }
        
        /* Children container */
        .children-container {
            display: block;
            margin-top: 10px;
        }
        
        /* Family separator line between different root families */
        .family-separator {
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--gold-500) 20%, 
                var(--gold-500) 80%, 
                transparent 100%);
            margin: 40px 0;
            position: relative;
        }
        
        .family-separator::after {
            content: '◆';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: var(--bark-900);
            color: var(--gold-500);
            padding: 0 10px;
            font-size: 12px;
        }
        
        /* Person Detail Modal */
        .person-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .person-detail-content {
            background: linear-gradient(135deg, var(--bark-900) 0%, var(--bark-800) 100%);
            border: 2px solid var(--gold-500);
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .person-detail-close {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: var(--gold-500);
            border: none;
            border-radius: 50%;
            color: var(--bark-900);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 1;
        }
        
        .person-detail-close:hover {
            background: var(--gold-400);
            transform: scale(1.1);
        }
        
        .person-detail-header {
            display: flex;
            gap: 20px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(212, 175, 55, 0.05) 100%);
            border-bottom: 1px solid var(--gold-500);
        }
        
        .person-detail-image {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            object-fit: cover;
            border: 3px solid var(--gold-400);
            flex-shrink: 0;
        }
        
        .person-detail-info {
            flex: 1;
        }
        
        .person-detail-info h2 {
            color: var(--gold-300);
            font-size: 24px;
            margin: 0 0 10px 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .person-detail-years {
            color: var(--parchment);
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .person-detail-gender {
            color: var(--gold-500);
            font-size: 14px;
            opacity: 0.8;
        }
        
        .person-detail-body {
            padding: 20px 30px 30px;
        }
        
        .person-detail-section {
            margin-bottom: 25px;
        }
        
        .person-detail-section:last-child {
            margin-bottom: 0;
        }
        
        .person-detail-section h3 {
            color: var(--gold-400);
            font-size: 16px;
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .person-detail-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .person-detail-item {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--parchment);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .person-detail-item:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: var(--gold-500);
            transform: translateX(5px);
        }
        
        /* ===== END VERTICAL LAYOUT ===== */
        
        /* Code Folding Style - Vertical Line on Left */
        .tree-root.mobile-vertical {
            position: relative;
            padding-left: 30px; /* Space for the left gutter */
        }
        
        /* Continuous vertical line on the left */
        .tree-root.mobile-vertical::before {
            content: '';
            position: absolute;
            left: 5px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--gold-500);
            opacity: 0.3;
        }
        
        /* Toggle button - centered vertically on EVERY row */
        .fold-toggle {
            position: absolute;
            left: 0; /* Start from tree-node's left edge */
            margin-left: -22px; /* Move further left to avoid heart */
            top: 50%; /* Center vertically */
            transform: translateY(-50%); /* Perfect vertical centering */
            width: 18px;
            height: 18px;
            background: var(--gold-500);
            border: 2px solid var(--bark-900);
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: var(--bark-900);
            transition: all 0.2s;
            z-index: 10;
            user-select: none;
        }
        
        .fold-toggle:hover {
            background: var(--gold-400);
            transform: translateY(-50%) scale(1.15);
        }
        
        .fold-toggle.expanded::before {
            content: '−'; /* Minus sign when expanded */
        }
        
        .fold-toggle.collapsed::before {
            content: '+'; /* Plus sign when collapsed */
        }
        
        /* Tree node positioning */
        .tree-node {
            position: relative;
        }
        
        /* Horizontal connector from vertical line to card */
        .tree-node::before {
            content: '';
            position: absolute;
            left: -15px; /* Adjusted for indent */
            top: 50%;
            width: 15px;
            height: 2px;
            background: var(--gold-500);
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <!-- Mobile Sidebar Toggle -->
    <div class="mobile-overlay" onclick="toggleMobileSidebar()"></div>
    
    <div class="app">
        <div class="sidebar" id="mobileSidebar">
            <div class="sidebar-header">
                <button class="mobile-sidebar-toggle sidebar-toggle-inside" onclick="toggleMobileSidebar()" aria-label="Close menu">☰</button>
                <div class="sidebar-title-group">
                    <h1 class="app-title">Heritage Tree</h1>
                    <p class="app-subtitle">Family Explorer</p>
                </div>
            </div>
            
            <!-- Controls Section in Sidebar -->
            <div class="sidebar-controls">
                <button class="control-btn" onclick="resetView(); closeMobileSidebarIfNeeded();">Reset View</button>
                <button class="control-btn" onclick="openDataManager(); closeMobileSidebarIfNeeded();" id="dataManagerBtn">Data Manager</button>
                <button class="control-btn" onclick="openThemeSelector(); closeMobileSidebarIfNeeded();" id="themeBtn">Theme Selector</button>
            </div>
            
            <div class="search-section" style="display: none;">
                <!-- Search moved to main view -->
            </div>
            
            <div class="person-list-container" id="personList" style="display: none;"></div>
        </div>
        
        <div class="tree-canvas">
            <!-- Search Bar with Hamburger -->
            <div class="main-search-bar">
                <button class="mobile-sidebar-toggle" onclick="toggleMobileSidebar()" aria-label="Toggle menu">☰</button>
                <input type="text" id="mainSearchInput" placeholder="🔍 Search family members..." onkeyup="filterTreeBySearch(this.value)">
            </div>
            
            <div class="tree-viewport" id="treeViewport">
                <div class="tree-scroll-content" id="treeContainer"></div>
            </div>
        </div>
    </div>
    
    <script>
    console.log('🧪 PHASE 1: Testing familyData array only');
    
    // PHASE 1: Just the data array - no processing
    let familyData = [
            {id: 1, name: "Ramaswamy", sex: "Male", born: "1825", until: "", spouseId: 2, imageId: ""},
            {id: 2, name: "Meenakshy", sex: "Female", born: "1835", until: "", spouseId: 1, imageId: ""},
            {id: 3, name: "Seshadri", sex: "Male", born: "1865", until: "", spouseId: 4, fatherId: 1, motherId: 2, imageId: ""},
            {id: 4, name: "Seshambal", sex: "Female", born: "1871", until: "", spouseId: 3, imageId: ""},
            {id: 5, name: "Plakkod", sex: "Male", born: "1887", until: "", fatherId: 3, motherId: 4, imageId: ""},
            {id: 6, name: "Mahadevan", sex: "Male", born: "1889", until: "1979", spouseId: 8, fatherId: 3, motherId: 4, imageId: ""},
            {id: 7, name: "Ramaswamy", sex: "Male", born: "1891", until: "", fatherId: 3, motherId: 4, imageId: ""},
            {id: 8, name: "Parvathy", sex: "Female", born: "", until: "", spouseId: 6, imageId: ""},
            {id: 9, name: "Seshambal - Parakulam", sex: "Female", born: "", until: "", spouseId: 16, fatherId: 6, motherId: 8, imageId: ""},
            {id: 10, name: "Subramaniam", sex: "Male", born: "", until: "", spouseId: 71, fatherId: 6, motherId: 8, imageId: ""},
            {id: 11, name: "Krishnan", sex: "Male", born: "", until: "", spouseId: 88, fatherId: 6, motherId: 8, imageId: ""},
            {id: 12, name: "Doraiswamy", sex: "Male", born: "", until: "", spouseId: 99, fatherId: 6, motherId: 8, imageId: ""},
            {id: 13, name: "Ramanathan", sex: "Male", born: "", until: "", spouseId: 20, fatherId: 6, motherId: 8, imageId: ""},
            {id: 14, name: "Meenakshy - Pudhukode", sex: "Female", born: "", until: "", spouseId: 111, fatherId: 6, motherId: 8, imageId: ""},
            {id: 15, name: "Sundaram", sex: "Male", born: "", until: "", spouseId: 127, fatherId: 6, motherId: 8, imageId: ""},
            {id: 16, name: "Raghunathan", sex: "Male", born: "", until: "", spouseId: 9, imageId: ""},
            {id: 17, name: "Seetharaman", sex: "Male", born: "", until: "", spouseId: 25, fatherId: 16, motherId: 9, imageId: ""},
            {id: 18, name: "Lakshmy", sex: "Female", born: "", until: "", spouseId: 36, fatherId: 16, motherId: 9, imageId: ""},
            {id: 19, name: "Jayam", sex: "Female", born: "", until: "", spouseId: 43, fatherId: 16, motherId: 9, imageId: ""},
            {id: 20, name: "Saroja", sex: "Female", born: "", until: "", spouseId: 13, fatherId: 16, motherId: 9, imageId: ""},
            {id: 21, name: "Mahadevan", sex: "Male", born: "", until: "", spouseId: 57, fatherId: 16, motherId: 9, imageId: ""},
            {id: 22, name: "Krishnamoorthy", sex: "Male", born: "", until: "", spouseId: 37, fatherId: 16, motherId: 9, imageId: ""},
            {id: 23, name: "Balan", sex: "Male", born: "", until: "", spouseId: 66, fatherId: 16, motherId: 9, imageId: ""},
            {id: 24, name: "Mohan", sex: "Male", born: "", until: "", spouseId: 49, fatherId: 16, motherId: 9, imageId: ""},
            {id: 25, name: "Swarnam", sex: "Female", born: "", until: "", spouseId: 17, imageId: ""},
            {id: 26, name: "Sumathy", sex: "Female", born: "", until: "", spouseId: 27, fatherId: 17, motherId: 25, imageId: ""},
            {id: 27, name: "Murali", sex: "Male", born: "", until: "", spouseId: 26, fatherId: 43, motherId: 19, imageId: ""},
            {id: 28, name: "Kowshik", sex: "Male", born: "", until: "", fatherId: 27, motherId: 26, imageId: ""},
            {id: 29, name: "Jayanthy", sex: "Female", born: "", until: "", spouseId: 30, fatherId: 17, motherId: 25, imageId: ""},
            {id: 30, name: "Keethi", sex: "Male", born: "", until: "", spouseId: 29, imageId: ""},
            {id: 31, name: "Siddhu", sex: "Male", born: "", until: "", fatherId: 30, motherId: 29, imageId: ""},
            {id: 32, name: "Kumar", sex: "Male", born: "", until: "", spouseId: 33, fatherId: 17, motherId: 25, imageId: ""},
            {id: 33, name: "Pathmaja", sex: "Female", born: "", until: "", spouseId: 32, imageId: ""},
            {id: 34, name: "Thulasi", sex: "Female", born: "", until: "", fatherId: 32, motherId: 33, imageId: ""},
            {id: 35, name: "Moorthy", sex: "Male", born: "", until: "", fatherId: 32, motherId: 33, imageId: ""},
            {id: 36, name: "Balasubramanian", sex: "Male", born: "", until: "", spouseId: 18, imageId: ""},
            {id: 37, name: "Chandra", sex: "Female", born: "", until: "", spouseId: 22, fatherId: 36, motherId: 18, imageId: ""},
            {id: 38, name: "Sreekanth", sex: "Male", born: "", until: "", fatherId: 22, motherId: 37, imageId: ""},
            {id: 39, name: "Vasanthy", sex: "Female", born: "", until: "", spouseId: 40, fatherId: 36, motherId: 18, imageId: ""},
            {id: 40, name: "Muthukrishnan", sex: "Male", born: "", until: "", spouseId: 39, imageId: ""},
            {id: 41, name: "Gopalakrishnan", sex: "Male", born: "", until: "", fatherId: 40, motherId: 39, imageId: ""},
            {id: 42, name: "Sivaramakrishnan", sex: "Male", born: "", until: "", fatherId: 40, motherId: 39, imageId: ""},
            {id: 43, name: "Mani", sex: "Male", born: "", until: "", spouseId: 19, imageId: ""},
            {id: 44, name: "Sudha", sex: "Female", born: "", until: "", spouseId: 45, fatherId: 43, motherId: 19, imageId: ""},
            {id: 45, name: "Ravi", sex: "Male", born: "", until: "", spouseId: 44, imageId: ""},
            {id: 46, name: "Arun", sex: "Male", born: "", until: "", spouseId: 47, fatherId: 45, motherId: 44, imageId: ""},
            {id: 47, name: "Gowthamy", sex: "Female", born: "", until: "", spouseId: 46, imageId: ""},
            {id: 48, name: "Achuthan", sex: "Male", born: "", until: "", fatherId: 46, motherId: 47, imageId: ""},
            {id: 49, name: "Kala", sex: "Female", born: "", until: "", spouseId: 50, fatherId: 13, motherId: 20, imageId: ""},
            {id: 50, name: "Ganesh", sex: "Male", born: "", until: "", spouseId: 49, imageId: ""},
            {id: 51, name: "Kamakshi", sex: "Female", born: "", until: "", spouseId: 52, fatherId: 50, motherId: 49, imageId: ""},
            {id: 52, name: "Sreenesh", sex: "Male", born: "", until: "", spouseId: 51, imageId: ""},
            {id: 53, name: "Ravi", sex: "Male", born: "", until: "", spouseId: 54, fatherId: 13, motherId: 20, imageId: ""},
            {id: 54, name: "Srividhya", sex: "Female", born: "", until: "", spouseId: 53, imageId: ""},
            {id: 55, name: "Ramnath", sex: "Male", born: "", until: "", spouseId: 56, fatherId: 53, motherId: 54, imageId: ""},
            {id: 56, name: "Abhinaya", sex: "Female", born: "", until: "", spouseId: 55, imageId: ""},
            {id: 57, name: "Buvana", sex: "Female", born: "", until: "", spouseId: 21, imageId: ""},
            {id: 58, name: "Sangeetha", sex: "Female", born: "", until: "", spouseId: 59, fatherId: 21, motherId: 57, imageId: ""},
            {id: 59, name: "Sreedhar", sex: "Male", born: "", until: "", spouseId: 58, imageId: ""},
            {id: 60, name: "Shreya", sex: "Female", born: "", until: "", spouseId: 62, fatherId: 59, motherId: 58, imageId: ""},
            {id: 61, name: "Shreyas", sex: "Male", born: "", until: "", fatherId: 59, motherId: 58, imageId: ""},
            {id: 62, name: "Yash", sex: "Male", born: "", until: "", spouseId: 60, imageId: ""},
            {id: 63, name: "Ambika", sex: "Female", born: "", until: "", spouseId: 64, fatherId: 21, motherId: 57, imageId: ""},
            {id: 64, name: "Babu", sex: "Male", born: "", until: "", spouseId: 63, imageId: ""},
            {id: 65, name: "Sivani", sex: "Female", born: "", until: "", fatherId: 64, motherId: 63, imageId: ""},
            {id: 66, name: "Kannamma", sex: "Female", born: "", until: "", spouseId: 23, imageId: ""},
            {id: 67, name: "Manikandan", sex: "Male", born: "", until: "", fatherId: 23, motherId: 66, imageId: ""},
            {id: 68, name: "Baby", sex: "Female", born: "", until: "", fatherId: 23, motherId: 66, imageId: ""},
            {id: 69, name: "Vasheekar", sex: "Male", born: "", until: "", fatherId: 24, motherId: 49, imageId: ""},
            {id: 70, name: "Yadav", sex: "Male", born: "", until: "", fatherId: 24, motherId: 49, imageId: ""},
            {id: 71, name: "Seethalakshmi", sex: "Female", born: "", until: "", spouseId: 10, imageId: ""},
            {id: 72, name: "Mahadevan (Ramani)", sex: "Male", born: "", until: "", spouseId: 73, fatherId: 10, motherId: 71, imageId: ""},
            {id: 73, name: "Radhai", sex: "Female", born: "", until: "", spouseId: 72, imageId: ""},
            {id: 74, name: "Ramya", sex: "Female", born: "", until: "", spouseId: 75, fatherId: 72, motherId: 73, imageId: ""},
            {id: 75, name: "Vijayesh", sex: "Male", born: "", until: "", spouseId: 74, imageId: ""},
            {id: 76, name: "Rishab", sex: "Male", born: "", until: "", fatherId: 75, motherId: 74, imageId: ""},
            {id: 77, name: "Rajeev", sex: "Male", born: "", until: "", spouseId: 78, fatherId: 72, motherId: 73, imageId: ""},
            {id: 78, name: "Mridhula", sex: "Female", born: "", until: "", spouseId: 77, imageId: ""},
            {id: 79, name: "Jayashree", sex: "Female", born: "", until: "", spouseId: 80, fatherId: 10, motherId: 71, imageId: ""},
            {id: 80, name: "Ramaswamy", sex: "Male", born: "", until: "", spouseId: 79, imageId: ""},
            {id: 81, name: "Shweta", sex: "Female", born: "", until: "", spouseId: 82, fatherId: 80, motherId: 79, imageId: ""},
            {id: 82, name: "Anand", sex: "Male", born: "", until: "", spouseId: 81, imageId: ""},
            {id: 83, name: "Siddharth", sex: "Male", born: "", until: "", fatherId: 82, motherId: 81, imageId: ""},
            {id: 84, name: "Akshaya", sex: "Female", born: "", until: "", fatherId: 82, motherId: 81, imageId: ""},
            {id: 85, name: "Shankar", sex: "Male", born: "", until: "", fatherId: 80, motherId: 79, imageId: ""},
            {id: 86, name: "Shekar", sex: "Male", born: "", until: "", spouseId: 87, fatherId: 80, motherId: 79, imageId: ""},
            {id: 87, name: "Priya", sex: "Female", born: "", until: "", spouseId: 86, imageId: ""},
            {id: 88, name: "Radha (Periammai)", sex: "Female", born: "", until: "", spouseId: 11, imageId: ""},
            {id: 89, name: "Chandra", sex: "Female", born: "", until: "", spouseId: 90, fatherId: 11, motherId: 88, imageId: ""},
            {id: 90, name: "Chandrashekar", sex: "Male", born: "", until: "", spouseId: 89, imageId: ""},
            {id: 91, name: "Sowmya", sex: "Female", born: "", until: "", spouseId: 93, fatherId: 90, motherId: 89, imageId: ""},
            {id: 92, name: "Kaavya", sex: "Female", born: "", until: "", fatherId: 90, motherId: 89, imageId: ""},
            {id: 93, name: "Satish", sex: "Male", born: "", until: "", spouseId: 91, imageId: ""},
            {id: 94, name: "Sathvik", sex: "Male", born: "", until: "", fatherId: 93, motherId: 91, imageId: ""},
            {id: 95, name: "Sanjana", sex: "Female", born: "", until: "", fatherId: 93, motherId: 91, imageId: ""},
            {id: 96, name: "Suresh", sex: "Male", born: "", until: "", spouseId: 97, fatherId: 11, motherId: 88, imageId: ""},
            {id: 97, name: "Usha", sex: "Female", born: "", until: "", spouseId: 96, imageId: ""},
            {id: 98, name: "Sabareesh", sex: "Male", born: "", until: "", fatherId: 96, motherId: 97, imageId: ""},
            {id: 99, name: "Vijayam", sex: "Female", born: "", until: "", spouseId: 12, imageId: ""},
            {id: 100, name: "Rajeshwari (Raji)", sex: "Female", born: "", until: "", spouseId: 101, fatherId: 12, motherId: 99, imageId: ""},
            {id: 101, name: "Ravikumar", sex: "Male", born: "", until: "", spouseId: 100, imageId: ""},
            {id: 102, name: "Santhosh", sex: "Female", born: "", until: "", fatherId: 101, motherId: 100, imageId: ""},
            {id: 103, name: "Ramesh", sex: "Male", born: "", until: "", spouseId: 105, fatherId: 12, motherId: 99, imageId: ""},
            {id: 104, name: "Sridhar", sex: "Male", born: "", until: "", spouseId: 108, fatherId: 12, motherId: 99, imageId: ""},
            {id: 105, name: "Rama", sex: "Female", born: "", until: "", spouseId: 103, imageId: ""},
            {id: 106, name: "Akilesh", sex: "Male", born: "", until: "", fatherId: 103, motherId: 105, imageId: ""},
            {id: 107, name: "Anirudh", sex: "Male", born: "", until: "", fatherId: 103, motherId: 105, imageId: ""},
            {id: 108, name: "Kalpana", sex: "Female", born: "", until: "", spouseId: 104, imageId: ""},
            {id: 109, name: "Sreyas", sex: "Male", born: "", until: "", fatherId: 104, motherId: 108, imageId: ""},
            {id: 110, name: "Venkat", sex: "Male", born: "", until: "", fatherId: 104, motherId: 108, imageId: ""},
            {id: 111, name: "Ramanathan (Puthukode)", sex: "Male", born: "", until: "", spouseId: 14, imageId: ""},
            {id: 112, name: "Geetha", sex: "Female", born: "", until: "", spouseId: 113, fatherId: 111, motherId: 14, imageId: ""},
            {id: 113, name: "Gopalakrishnan", sex: "Male", born: "", until: "", spouseId: 112, imageId: ""},
            {id: 114, name: "Priya", sex: "Female", born: "", until: "", spouseId: 115, fatherId: 113, motherId: 112, imageId: ""},
            {id: 115, name: "Sreeram", sex: "Male", born: "", until: "", spouseId: 114, imageId: ""},
            {id: 116, name: "Shreya", sex: "Female", born: "", until: "", fatherId: 115, motherId: 114, imageId: ""},
            {id: 117, name: "Ganesh", sex: "Male", born: "", until: "", spouseId: 118, fatherId: 111, motherId: 14, imageId: ""},
            {id: 118, name: "Vidya", sex: "Female", born: "", until: "", spouseId: 117, imageId: ""},
            {id: 119, name: "Krish", sex: "Male", born: "", until: "", fatherId: 117, motherId: 118, imageId: ""},
            {id: 120, name: "Lakshmy", sex: "Female", born: "", until: "", fatherId: 117, motherId: 118, imageId: ""},
            {id: 121, name: "Murali", sex: "Male", born: "", until: "", spouseId: 122, fatherId: 111, motherId: 14, imageId: ""},
            {id: 122, name: "Mallika", sex: "Female", born: "", until: "", spouseId: 121, imageId: ""},
            {id: 123, name: "Mithesh", sex: "Male", born: "", until: "", fatherId: 121, motherId: 122, imageId: ""},
            {id: 124, name: "Raja", sex: "Male", born: "", until: "", spouseId: 125, fatherId: 111, motherId: 14, imageId: ""},
            {id: 125, name: "Priya", sex: "Female", born: "", until: "", spouseId: 124, imageId: ""},
            {id: 126, name: "Kamya", sex: "Female", born: "", until: "", fatherId: 124, motherId: 125, imageId: ""},
            {id: 127, name: "Radha", sex: "Female", born: "", until: "", spouseId: 15, imageId: "1EdGoK5XUalBQ_363CJIFfBsQIiYqnRMq"},
            {id: 128, name: "Mahadevan (Murali)", sex: "Male", born: "", until: "", spouseId: 129, fatherId: 15, motherId: 127, imageId: "1gs4-UN2i8kreTe2CPtuGY852TKBl57-0"},
            {id: 129, name: "Shalini", sex: "Female", born: "", until: "", spouseId: 128, imageId: "1-Zmw2oU-YZHECRgZDy_A03pa6pXRtxXV"},
            {id: 130, name: "Amrit", sex: "Male", born: "", until: "", fatherId: 128, motherId: 129, imageId: "1R4tTnaw9uewCcfeFMyNliqUmP-HQ90Ho"},
            {id: 131, name: "Ayusha", sex: "Female", born: "", until: "", fatherId: 128, motherId: 129, imageId: ""},
            {id: 132, name: "Venkateswaran (Ganesh)", sex: "Male", born: "", until: "", spouseId: 133, fatherId: 15, motherId: 127, imageId: "1oP2lQb5R4KoI4DDGYrEdgyoIAJltxel4"},
            {id: 133, name: "Krithika", sex: "Female", born: "", until: "", spouseId: 132, imageId: ""},
            {id: 134, name: "Abhinav", sex: "Male", born: "", until: "", fatherId: 132, motherId: 133, imageId: ""},
            {id: 135, name: "Apurva", sex: "Female", born: "", until: "", fatherId: 132, motherId: 133, imageId: ""}
        ];
        
        console.log('✅ PHASE 1: familyData loaded -', familyData.length, 'people');
        console.log('   First person:', familyData[0].name);
        console.log('   Last person:', familyData[familyData.length - 1].name);
        
        // PHASE 4: Enabling all helper functions
        
        const DEBUG_MODE = false;
        const debug = (...args) => { if (DEBUG_MODE) console.log(...args); };
        
        console.log('🧪 PHASE 4: Helper functions enabled');
        
        debug('📊 Initial family data count:', familyData.length);
        
        let personMap = {};
        familyData.forEach(p => personMap[p.id] = p);
        
        function calculateGeneration(person, visited = new Set()) {
            if (visited.has(person.id)) return 0;
            visited.add(person.id);
            if (!person.fatherId && !person.motherId) return 1;
            let maxGen = 0;
            if (person.fatherId && personMap[person.fatherId]) 
                maxGen = Math.max(maxGen, calculateGeneration(personMap[person.fatherId], visited));
            if (person.motherId && personMap[person.motherId]) 
                maxGen = Math.max(maxGen, calculateGeneration(personMap[person.motherId], visited));
            return maxGen + 1;
        }
        
        try {
            familyData.forEach(p => p.generation = calculateGeneration(p));
        } catch (error) {
            console.error('❌ Generation calculation failed:', error.message);
            // Fallback: set all to generation 1
            familyData.forEach(p => p.generation = 1);
        }
        
        function getChildren(personId) {
            return familyData.filter(p => p.fatherId == personId || p.motherId == personId);
        }
        
        function getSiblings(person) {
            if (!person.fatherId && !person.motherId) return [];
            return familyData.filter(p => 
                p.id !== person.id && 
                ((person.fatherId && p.fatherId == person.fatherId) || 
                 (person.motherId && p.motherId == person.motherId))
            );
        }
        
        function toggleRelationshipMode() {
            relationshipMode = !relationshipMode;
            const panel = document.getElementById('relationshipPanel');
            const btn = document.getElementById('relationshipBtn');
            
            if (relationshipMode) {
                panel.style.display = 'block';
                btn.classList.add('active');
                relationshipPerson1 = null;
                relationshipPerson2 = null;
                document.getElementById('person1Name').textContent = 'Not selected';
                document.getElementById('person2Name').textContent = 'Not selected';
                document.getElementById('relationshipResult').classList.remove('show');
            } else {
                panel.style.display = 'none';
                btn.classList.remove('active');
            }
        }
        
        function closeRelationshipMode() {
            relationshipMode = false;
            document.getElementById('relationshipPanel').style.display = 'none';
            document.getElementById('relationshipBtn').classList.remove('active');
            relationshipPerson1 = null;
            relationshipPerson2 = null;
        }
        
        function toggleDebugMode() {
            debugMode = !debugMode;
            const btn = document.getElementById('debugBtn');
            
            if (debugMode) {
                document.body.classList.add('debug-mode');
                btn.classList.add('active');
            } else {
                document.body.classList.remove('debug-mode');
                btn.classList.remove('active');
            }
        }
        
        function findRelationship(person1, person2) {
            if (!person1 || !person2) return null;
            
            // Check if they're the same person
            if (person1.id === person2.id) {
                return { type: 'Same Person', path: [] };
            }
            
            // Check if they're spouses
            if (person1.spouseId === person2.id) {
                return { type: 'Spouse', path: [`${person1.name} is married to ${person2.name}`] };
            }
            
            // Check parent-child relationship
            if (person1.fatherId === person2.id || person1.motherId === person2.id) {
                return { type: 'Parent-Child', path: [`${person2.name} is the parent of ${person1.name}`] };
            }
            if (person2.fatherId === person1.id || person2.motherId === person1.id) {
                return { type: 'Parent-Child', path: [`${person1.name} is the parent of ${person2.name}`] };
            }
            
            // Check siblings
            const siblings1 = getSiblings(person1);
            if (siblings1.some(s => s.id === person2.id)) {
                return { type: 'Siblings', path: [`${person1.name} and ${person2.name} are siblings`] };
            }
            
            // Find common ancestor using BFS
            function getAncestors(person) {
                const ancestors = [];
                const queue = [{ person, path: [person] }];
                const visited = new Set();
                
                while (queue.length > 0) {
                    const { person: current, path } = queue.shift();
                    
                    if (visited.has(current.id)) continue;
                    visited.add(current.id);
                    
                    ancestors.push({ person: current, path: [...path] });
                    
                    if (current.fatherId && personMap[current.fatherId]) {
                        queue.push({ person: personMap[current.fatherId], path: [...path, personMap[current.fatherId]] });
                    }
                    if (current.motherId && personMap[current.motherId]) {
                        queue.push({ person: personMap[current.motherId], path: [...path, personMap[current.motherId]] });
                    }
                }
                
                return ancestors;
            }
            
            const ancestors1 = getAncestors(person1);
            const ancestors2 = getAncestors(person2);
            
            // Find common ancestor
            for (const a1 of ancestors1) {
                for (const a2 of ancestors2) {
                    if (a1.person.id === a2.person.id) {
                        // Found common ancestor
                        const commonAncestor = a1.person;
                        const distance1 = a1.path.length - 1;
                        const distance2 = a2.path.length - 1;
                        
                        let relationship = '';
                        const path = [];
                        
                        // Build path description
                        if (distance1 === 1 && distance2 === 2) {
                            relationship = 'Grandparent-Grandchild';
                            path.push(`${person1.name} is the grandchild of ${commonAncestor.name}`);
                            path.push(`${person2.name} is also descended from ${commonAncestor.name}`);
                        } else if (distance1 === 2 && distance2 === 1) {
                            relationship = 'Grandparent-Grandchild';
                            path.push(`${person2.name} is the grandchild of ${commonAncestor.name}`);
                            path.push(`${person1.name} is also descended from ${commonAncestor.name}`);
                        } else if (distance1 === 1 && distance2 === 1) {
                            // Check if same parents (already handled as siblings above, but for spouses' siblings)
                            relationship = 'Siblings through ' + commonAncestor.name;
                        } else if (distance1 === 2 && distance2 === 2) {
                            relationship = 'Cousins';
                            path.push(`${person1.name} and ${person2.name} are cousins`);
                            path.push(`Common ancestor: ${commonAncestor.name}`);
                        } else {
                            const removedDegree = Math.min(distance1, distance2) - 1;
                            const timesRemoved = Math.abs(distance1 - distance2);
                            
                            if (removedDegree === 1) {
                                relationship = timesRemoved === 0 ? 'Cousins' : `${timesRemoved}x removed cousin`;
                            } else {
                                relationship = `${removedDegree}${getOrdinal(removedDegree)} cousins` + (timesRemoved > 0 ? `, ${timesRemoved}x removed` : '');
                            }
                            
                            path.push(`Common ancestor: ${commonAncestor.name}`);
                            path.push(`${person1.name} is ${distance1} generation${distance1 > 1 ? 's' : ''} below`);
                            path.push(`${person2.name} is ${distance2} generation${distance2 > 1 ? 's' : ''} below`);
                        }
                        
                        return { type: relationship, path, commonAncestor };
                    }
                }
            }
            
            return { type: 'No Direct Relationship Found', path: ['These individuals do not share a common ancestor in the tree'] };
        }
        
        function getOrdinal(n) {
            const s = ['th', 'st', 'nd', 'rd'];
            const v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }
        
        let selectedPerson = null;
        let relationshipPath = new Set(); // For highlighting relationship paths
        let filteredPeople = [...familyData];
        let expandedNodes = new Set();
        let maxDepth = 2;
        
        // Relationship mode
        let relationshipMode = false;
        let relationshipPerson1 = null;
        let relationshipPerson2 = null;
        
        // Collapsed sections - tracks which directions are hidden per person
        // Format: collapsedSections.set(personId, { up: false, down: true, left: false, right: false })
        // Junction visibility - tracks which directions are hidden for each person
        // Format: hiddenDirections.get(personId) = { top: false, bottom: true, left: false, right: false }
        let hiddenDirections = new Map();
        
        // Debug mode
        let debugMode = false;
        
        function populateGenerationFilter() {
            const gens = [...new Set(familyData.map(p => p.generation))].sort((a,b) => a-b);
            const sel = document.getElementById('generationFilter');
            gens.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.textContent = `Generation ${g}`;
                sel.appendChild(opt);
            });
        }
        
        // Filter tree by search in main view
        function filterTreeBySearch(searchText) {
            const query = searchText.toLowerCase().trim();
            const cards = document.querySelectorAll('.node-card');
            
            if (!query) {
                // Show all cards if search is empty
                cards.forEach(card => {
                    card.style.display = '';
                    card.style.opacity = '1';
                });
                return;
            }
            
            cards.forEach(card => {
                const name = card.querySelector('.node-name') ? card.querySelector('.node-name').textContent.toLowerCase() : '';
                const dates = card.querySelector('.node-dates') ? card.querySelector('.node-dates').textContent.toLowerCase() : '';
                
                if (name.includes(query) || dates.includes(query)) {
                    card.style.display = '';
                    card.style.opacity = '1';
                } else {
                    card.style.opacity = '0.2';
                }
            });
        }
        
        function filterPeople() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const genFilter = document.getElementById('generationFilter').value;
            const sexFilter = document.getElementById('genderFilter').value;
            
            filteredPeople = familyData.filter(p => {
                const matchSearch = p.name.toLowerCase().includes(search);
                const matchGen = !genFilter || p.generation == genFilter;
                const matchSex = !sexFilter || p.sex === sexFilter;
                return matchSearch && matchGen && matchSex;
            });
            
            displayPeopleList();
        }
        
        function displayPeopleList() {
            const list = document.getElementById('personList');
            if (!list) return; // Sidebar list removed
            
            if (filteredPeople.length === 0) {
                list.innerHTML = '<div style="text-align:center;padding:40px;color:var(--gold-300);opacity:0.5;">No matches found</div>';
                return;
            }
            
            list.innerHTML = filteredPeople.map(p => `
                <div class="person-item ${selectedPerson && selectedPerson.id === p.id ? 'selected' : ''}" onclick="selectPerson(${p.id})">
                    <div class="person-name-list">${p.name}</div>
                    <div class="person-meta">
                        <span class="badge-sm ${p.sex.toLowerCase()}">${p.sex}</span>
                        <span style="font-size:11px;">Gen ${p.generation}</span>
                        ${p.born ? `<span>b.${p.born}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function selectPerson(personId) {
            debug('👤 selectPerson called with ID:', personId);
            const person = personMap[personId];
            if (!person) {
                console.warn('⚠️ Person not found:', personId);
                return;
            }
            
            debug('✅ Person found:', person.name);
            
            // Close sidebar when selecting
            closeMobileSidebarIfNeeded();
            
            // Show detail modal
            showPersonDetail(person);
        }
        
        function showPersonDetail(person) {
            debug('📋 showPersonDetail called for:', person.name);
            
            // Build detail HTML
            const imgUrl = person.imageId ? `https://lh3.googleusercontent.com/d/${person.imageId}` : '';
            const years = person.born || person.until ? 
                `${person.born || '?'} - ${person.until || 'Present'}` : 'Unknown';
            
            // Get relationships
            const father = person.fatherId ? personMap[person.fatherId] : null;
            const mother = person.motherId ? personMap[person.motherId] : null;
            const spouse = person.spouseId ? personMap[person.spouseId] : null;
            const children = familyData.filter(p => p.fatherId === person.id || p.motherId === person.id);
            const siblings = familyData.filter(p => 
                p.id !== person.id && 
                ((p.fatherId && p.fatherId === person.fatherId) || 
                 (p.motherId && p.motherId === person.motherId))
            );
            
            // Build HTML
            let html = `
                <div class="person-detail-content" onclick="event.stopPropagation()">
                    <button class="person-detail-close" onclick="closePersonDetail()">×</button>
                        
                        <div class="person-detail-header">
                            ${imgUrl ? `<img src="${imgUrl}" class="person-detail-image" onerror="this.style.display='none'">` : ''}
                            <div class="person-detail-info">
                                <h2>${person.name}</h2>
                                <div class="person-detail-years">${years}</div>
                                <div class="person-detail-gender">${person.sex}</div>
                            </div>
                        </div>
                        
                        <div class="person-detail-body">`;
            
            // Parents
            if (father || mother) {
                html += `<div class="person-detail-section">
                    <h3>Parents</h3>
                    <div class="person-detail-list">`;
                if (father) html += `<div class="person-detail-item" onclick="showPersonDetail(personMap[${father.id}])">${father.name}</div>`;
                if (mother) html += `<div class="person-detail-item" onclick="showPersonDetail(personMap[${mother.id}])">${mother.name}</div>`;
                html += `</div></div>`;
            }
            
            // Spouse
            if (spouse) {
                html += `<div class="person-detail-section">
                    <h3>Spouse</h3>
                    <div class="person-detail-list">
                        <div class="person-detail-item" onclick="showPersonDetail(personMap[${spouse.id}])">${spouse.name}</div>
                    </div>
                </div>`;
            }
            
            // Siblings
            if (siblings.length > 0) {
                html += `<div class="person-detail-section">
                    <h3>Siblings</h3>
                    <div class="person-detail-list">`;
                siblings.forEach(sib => {
                    html += `<div class="person-detail-item" onclick="showPersonDetail(personMap[${sib.id}])">${sib.name}</div>`;
                });
                html += `</div></div>`;
            }
            
            // Children
            if (children.length > 0) {
                html += `<div class="person-detail-section">
                    <h3>Children</h3>
                    <div class="person-detail-list">`;
                children.forEach(child => {
                    html += `<div class="person-detail-item" onclick="showPersonDetail(personMap[${child.id}])">${child.name}</div>`;
                });
                html += `</div></div>`;
            }
            
            html += `</div></div>`;
            
            debug('🏗️ Modal HTML built, length:', html.length);
            
            // Add to page
            let modal = document.getElementById('personDetailModal');
            if (!modal) {
                debug('📦 Creating new modal element');
                modal = document.createElement('div');
                modal.id = 'personDetailModal';
                modal.className = 'person-detail-modal';
                document.body.appendChild(modal);
            } else {
                debug('♻️ Reusing existing modal');
            }
            
            modal.innerHTML = html;
            modal.style.display = 'flex';
            modal.onclick = (event) => {
                if (event.target === modal) closePersonDetail();
            };
            
            debug('✅ Modal display set to:', modal.style.display);
            debug('✅ Modal in DOM:', document.getElementById('personDetailModal') !== null);
            debug('✅ Modal computed display:', window.getComputedStyle(modal).display);
        }
        
        function closePersonDetail(event) {
            if (event) event.stopPropagation();
            const modal = document.getElementById('personDetailModal');
            if (modal) modal.style.display = 'none';
        }
        
        function showRelationshipTree(person1, person2, relationshipResult) {
            expandedNodes.clear();
            selectedPerson = null;
            
            debug('Showing relationship tree for:', person1.name, 'and', person2.name);
            
            // Build the path from person to root
            function getAncestorPath(person) {
                const path = [person];
                let current = person;
                
                while (current.fatherId || current.motherId) {
                    const parent = personMap[current.fatherId] || personMap[current.motherId];
                    if (!parent) break;
                    path.push(parent);
                    current = parent;
                }
                
                return path;
            }
            
            const path1 = getAncestorPath(person1);
            const path2 = getAncestorPath(person2);
            
            debug('Path 1:', path1.map(p => p.name));
            debug('Path 2:', path2.map(p => p.name));
            
            // Find common ancestor
            let commonAncestor = null;
            let commonIndex1 = -1;
            let commonIndex2 = -1;
            
            for (let i = 0; i < path1.length; i++) {
                for (let j = 0; j < path2.length; j++) {
                    if (path1[i].id === path2[j].id) {
                        commonAncestor = path1[i];
                        commonIndex1 = i;
                        commonIndex2 = j;
                        break;
                    }
                }
                if (commonAncestor) break;
            }
            
            debug('Common ancestor:', commonAncestor ? commonAncestor.name : 'None');
            
            if (commonAncestor) {
                // Add the ENTIRE path from root down to both people
                // This ensures parent nodes are expanded so children are visible
                
                // Add full path to common ancestor and beyond
                path1.forEach(p => {
                    expandedNodes.add(p.id);
                    if (p.spouseId) expandedNodes.add(p.spouseId);
                });
                
                path2.forEach(p => {
                    expandedNodes.add(p.id);
                    if (p.spouseId) expandedNodes.add(p.spouseId);
                });
                
                // Add siblings at each level for context
                // Siblings of person1
                const siblings1 = getSiblings(person1);
                siblings1.forEach(s => {
                    expandedNodes.add(s.id);
                    if (s.spouseId) expandedNodes.add(s.spouseId);
                });
                
                // Siblings of person2
                const siblings2 = getSiblings(person2);
                siblings2.forEach(s => {
                    expandedNodes.add(s.id);
                    if (s.spouseId) expandedNodes.add(s.spouseId);
                });
                
                // Siblings of their parents (to show the full generation)
                if (person1.fatherId || person1.motherId) {
                    const parent1 = personMap[person1.fatherId] || personMap[person1.motherId];
                    if (parent1) {
                        const parentSiblings1 = getSiblings(parent1);
                        parentSiblings1.forEach(s => {
                            expandedNodes.add(s.id);
                            if (s.spouseId) expandedNodes.add(s.spouseId);
                        });
                    }
                }
                
                if (person2.fatherId || person2.motherId) {
                    const parent2 = personMap[person2.fatherId] || personMap[person2.motherId];
                    if (parent2) {
                        const parentSiblings2 = getSiblings(parent2);
                        parentSiblings2.forEach(s => {
                            expandedNodes.add(s.id);
                            if (s.spouseId) expandedNodes.add(s.spouseId);
                        });
                    }
                }
                
                debug('Expanded nodes:', Array.from(expandedNodes));
                debug('Expanded nodes count:', expandedNodes.size);
            } else {
                // No common ancestor found, show both full paths
                path1.forEach(p => {
                    expandedNodes.add(p.id);
                    if (p.spouseId) expandedNodes.add(p.spouseId);
                });
                path2.forEach(p => {
                    expandedNodes.add(p.id);
                    if (p.spouseId) expandedNodes.add(p.spouseId);
                });
            }
            
            renderTree();
            
            // Scroll to show first person
            setTimeout(() => {
                const cards = document.querySelectorAll('.node-card.relationship-highlight');
                if (cards.length > 0) {
                    cards[0].scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                }
            }, 200);
        }
        
        // Mobile layout toggle (for testing on desktop)
        let forceMobileLayout = false;
        
        function toggleMobileLayout() {
            forceMobileLayout = !forceMobileLayout;
            const btn = document.getElementById('mobileLayoutBtn');
            btn.textContent = `Mobile Layout: ${forceMobileLayout ? 'ON' : 'OFF'}`;
            btn.style.background = forceMobileLayout ? 
                'linear-gradient(135deg, rgba(244, 162, 97, 0.3), rgba(244, 162, 97, 0.2))' : 
                'linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.08))';
            debug('🔄 Mobile layout toggled:', forceMobileLayout ? 'ON' : 'OFF');
            renderTree();
        }
        
        // Toggle function - collapses/expands based on generation level
        function toggleFold(foldId, event) {
            event.stopPropagation(); // Prevent card click
            
            const toggle = event.currentTarget;
            const treeNode = toggle.closest('.tree-node');
            const generation = parseInt(treeNode.getAttribute('data-generation'));
            
            debug('🔘 Toggle clicked for:', foldId, 'at generation:', generation);
            
            // Find the children-container for this person
            const childrenContainer = document.getElementById(foldId);
            
            if (!childrenContainer) {
                console.log('⚠️ No children container found for:', foldId);
                return;
            }
            
            // Check current state
            const isExpanded = toggle.classList.contains('expanded');
            
            if (isExpanded) {
                // COLLAPSE: Hide the entire children container
                console.log('📁 Collapsing children container');
                childrenContainer.style.display = 'none';
                
                // Update toggle appearance
                toggle.classList.remove('expanded');
                toggle.classList.add('collapsed');
                
            } else {
                // EXPAND: Show the children container
                debug('📂 Expanding children container');
                childrenContainer.style.display = 'block';
                
                // Update toggle appearance
                toggle.classList.remove('collapsed');
                toggle.classList.add('expanded');
            }
        }
        
        // DEBUG HELPER: Run debugToggles() in console to see all toggle positions
        window.debugToggles = function() {
            const toggles = document.querySelectorAll('.fold-toggle');
            debug('=== TOGGLE DEBUG INFO ===');
            debug('Total toggles found:', toggles.length);
            debug('Total tree-nodes:', document.querySelectorAll('.tree-node').length);
            
            toggles.forEach((toggle, index) => {
                const treeNode = toggle.closest('.tree-node');
                const generation = treeNode ? treeNode.getAttribute('data-generation') : null;
                const personId = toggle.getAttribute('data-person-id');
                const rect = toggle.getBoundingClientRect();
                const nodeRect = treeNode ? treeNode.getBoundingClientRect() : null;
                
                debug(`Toggle ${index + 1}:`, {
                    personId,
                    generation,
                    left: rect.left,
                    top: rect.top,
                    nodeLeft: nodeRect ? nodeRect.left : null,
                    nodeTop: nodeRect ? nodeRect.top : null,
                    visible: rect.width > 0 && rect.height > 0
                });
            });
            
            const treeNodes = document.querySelectorAll('.tree-node');
            const nodesWithoutToggle = [];
            treeNodes.forEach(node => {
                if (!node.querySelector('.fold-toggle')) {
                    nodesWithoutToggle.push(node);
                }
            });
            
            if (nodesWithoutToggle.length > 0) {
                console.warn('⚠️ Nodes WITHOUT toggles:', nodesWithoutToggle.length);
                nodesWithoutToggle.forEach(node => {
                    debug('  Missing toggle on generation:', node.getAttribute('data-generation'));
                });
            }
            
            debug('=== END DEBUG ===');
        };
        
        // DEBUG HELPER: Check padding and positioning
        window.debugLayout = function() {
            debug('=== LAYOUT DEBUG ===');
            
            // Check each generation
            for (let gen = 0; gen <= 3; gen++) {
                const nodes = document.querySelectorAll(`.tree-node[data-generation="${gen}"]`);
                if (nodes.length > 0) {
                    const firstNode = nodes[0];
                    const spousePair = firstNode.querySelector('.spouse-pair');
                    const singlePerson = firstNode.querySelector('.single-person');
                    const content = spousePair || singlePerson;
                    
                    const nodeStyles = window.getComputedStyle(firstNode);
                    const contentStyles = content ? window.getComputedStyle(content) : null;
                    
                    debug(`Generation ${gen}:`, {
                        nodes: nodes.length,
                        nodeMarginLeft: nodeStyles.marginLeft,
                        contentPaddingLeft: contentStyles ? contentStyles.paddingLeft : null,
                        nodeRect: firstNode.getBoundingClientRect(),
                        contentRect: content ? content.getBoundingClientRect() : null
                    });
                }
            }
            
            // Check heart positioning
            const spousePairs = document.querySelectorAll('.spouse-pair');
            if (spousePairs.length > 0) {
                const firstPair = spousePairs[0];
                const afterStyles = window.getComputedStyle(firstPair, '::after');
                debug('Heart (::after) position:', {
                    left: afterStyles.left,
                    top: afterStyles.top,
                    transform: afterStyles.transform,
                    content: afterStyles.content
                });
            }
            
            debug('=== END LAYOUT DEBUG ===');
        };
        
        // DEBUG HELPER: Check card and image styles
        window.debugCards = function() {
            debug('=== CARD DEBUG ===');
            
            const cards = document.querySelectorAll('.node-card');
            debug('Total cards found:', cards.length);
            
            if (cards.length > 0) {
                // Find a card WITH an image
                let cardWithImage = null;
                for (let card of cards) {
                    if (card.querySelector('.node-image')) {
                        cardWithImage = card;
                        break;
                    }
                }
                
                const firstCard = cardWithImage || cards[0];
                debug('Debugging card:', firstCard.querySelector('.node-name') ? firstCard.querySelector('.node-name').textContent : 'N/A');
                
                const cardStyles = window.getComputedStyle(firstCard);
                const image = firstCard.querySelector('.node-image');
                const imageStyles = image ? window.getComputedStyle(image) : null;
                const content = firstCard.querySelector('.node-content');
                const contentStyles = content ? window.getComputedStyle(content) : null;
                
                debug('Has image?', !!image);
                
                debug('Card styles:', {
                    padding: cardStyles.padding,
                    paddingTop: cardStyles.paddingTop,
                    paddingLeft: cardStyles.paddingLeft,
                    paddingBottom: cardStyles.paddingBottom,
                    gap: cardStyles.gap,
                    display: cardStyles.display,
                    flexDirection: cardStyles.flexDirection,
                    alignItems: cardStyles.alignItems,
                    overflow: cardStyles.overflow,
                    borderRadius: cardStyles.borderRadius,
                    minHeight: cardStyles.minHeight
                });
                
                if (image) {
                    debug('Image styles:', {
                        width: imageStyles.width,
                        height: imageStyles.height,
                        minHeight: imageStyles.minHeight,
                        margin: imageStyles.margin,
                        marginBottom: imageStyles.marginBottom,
                        border: imageStyles.border,
                        borderRadius: imageStyles.borderRadius,
                        objectFit: imageStyles.objectFit,
                        alignSelf: imageStyles.alignSelf,
                        flexShrink: imageStyles.flexShrink,
                        display: imageStyles.display,
                        rect: image.getBoundingClientRect()
                    });
                } else {
                    console.warn('⚠️ No image found in this card');
                }
                
                if (content) {
                    debug('Content styles:', {
                        padding: contentStyles.padding,
                        flex: contentStyles.flex,
                        rect: content.getBoundingClientRect()
                    });
                }
                
                debug('Card rect:', firstCard.getBoundingClientRect());
            }
            
            debug('=== END CARD DEBUG ===');
        };
        
        // Collapse all children in vertical view
        function collapseAllMobile() {
            // Set all toggles to collapsed
            document.querySelectorAll('.fold-toggle.expanded').forEach(toggle => {
                toggle.classList.remove('expanded');
                toggle.classList.add('collapsed');
            });
            
            // Hide all children-containers
            document.querySelectorAll('.children-container').forEach(container => {
                container.style.display = 'none';
            });
            
            debug('📁 All collapsed');
        }
        
        // Expand all children in vertical view
        function expandAllMobile() {
            // Set all toggles to expanded
            document.querySelectorAll('.fold-toggle.collapsed').forEach(toggle => {
                toggle.classList.remove('collapsed');
                toggle.classList.add('expanded');
            });
            
            // Show all children-containers
            document.querySelectorAll('.children-container').forEach(container => {
                container.style.display = 'block';
            });
            
            debug('📂 All expanded');
        }
        
        // Mobile detection
        function isMobileView() {
            return forceMobileLayout || window.innerWidth <= 768;
        }
        
        // Mobile vertical tree renderer
        function renderMobileTree(rootPerson) {
            console.log('📱 START renderMobileTree:', rootPerson ? rootPerson.name : 'null');
            let html = '';
            const rendered = new Set();
            
            // TESTING: Render root + children (depth 6)
            console.log('🧪 TEST MODE: Rendering to depth 6 (binary search)');
            const MAX_DEPTH = 6; // Test depth 6
            
            function renderPersonMobile(person, generation = 0) {
                console.log('  → renderPersonMobile:', person ? person.name : 'null', 'gen:', generation);
                if (!person) {
                    console.warn('⚠️ renderPersonMobile called with null person');
                    return '';
                }
                if (rendered.has(person.id)) {
                    console.log('  ⏭️ Already rendered:', person.name);
                    return '';
                }
                rendered.add(person.id);
                console.log('  ✏️ Rendering:', person.name, 'at generation', generation);
                
                let output = '';
                const spouse = person.spouseId ? personMap[person.spouseId] : null;
                const hasSpouse = spouse && !rendered.has(spouse.id);
                
                console.log('  📝 Creating card HTML for:', person.name);
                // Create person card HTML
                const cardHtml = renderPersonCard(person, generation);
                console.log('  ✅ Card HTML created');
                const spouseCardHtml = hasSpouse ? renderPersonCard(spouse, generation) : '';
                console.log('  ✅ Spouse card HTML created (if needed)');
                
                if (hasSpouse) {
                    console.log('  💑 Rendering spouse pair');
                    rendered.add(spouse.id);
                    output += `<div class="tree-node" data-generation="${generation}">
                        <div class="fold-toggle expanded" data-person-id="${person.id}" onclick="toggleFold('fold-${person.id}', event)"></div>
                        <div class="spouse-pair">
                            ${cardHtml}
                            ${spouseCardHtml}
                        </div>
                    </div>`;
                } else {
                    console.log('  👤 Rendering single person');
                    output += `<div class="tree-node" data-generation="${generation}">
                        <div class="fold-toggle expanded" data-person-id="${person.id}" onclick="toggleFold('fold-${person.id}', event)"></div>
                        <div class="single-person">${cardHtml}</div>
                    </div>`;
                }
                
                // TEST: Render children ONLY if we haven't hit max depth
                if (generation < MAX_DEPTH) {
                    console.log('  🔍 Finding children of:', person.name, '(depth', generation, '/', MAX_DEPTH, ')');
                    const children = familyData.filter(p => 
                        (p.fatherId === person.id || p.motherId === person.id) &&
                        !rendered.has(p.id)
                    );
                    
                    console.log('  👶 Children found:', children.length, 'for', person.name);
                    
                    if (children.length > 0) {
                        const foldId = `fold-${person.id}`;
                        output += `<div class="children-container expanded" id="${foldId}">`;
                        console.log('  🔄 Recursing into children...');
                        children.forEach((child, idx) => {
                            console.log('    Child', idx + 1, 'of', children.length, ':', child.name);
                            output += renderPersonMobile(child, generation + 1);
                        });
                        output += '</div>';
                        console.log('  ✅ Children rendering complete');
                    }
                } else {
                    console.log('  🛑 Max depth reached, skipping children');
                }
                
                console.log('  ← Returning from:', person.name);
                return output;
            }
            
            function renderPersonCard(person, generation) {
                const dirs = hiddenDirections.get(person.id) || {};
                const selected = selectedPerson && selectedPerson.id === person.id;
                const highlightClass = relationshipPath.has(person.id) ? 'highlighted' : '';
                
                const imgUrl = person.imageId ? `https://lh3.googleusercontent.com/d/${person.imageId}` : '';
                const cardDates = person.born || person.until ? 
                    `${person.born || '?'} - ${person.until || ''}` : '';
                
                return `<div class="node-card ${person.sex.toLowerCase()} ${selected ? 'selected' : ''} ${highlightClass} has-parent-line" 
                             onclick="selectPerson(${person.id})" data-generation="${generation}">
                    ${imgUrl ? `<img src="${imgUrl}" alt="${person.name}" class="node-image" onerror="this.style.display='none'">` : ''}
                    <div class="node-content">
                        <div class="node-name" title="${person.name}">${person.name}</div>
                        ${cardDates ? `<div class="node-dates">${cardDates}</div>` : ''}
                    </div>
                </div>`;
            }
            
            const result = renderPersonMobile(rootPerson, 0);
            debug('📱 Mobile tree HTML length:', result.length, 'characters');
            debug('📱 Total people rendered:', rendered.size);
            return result;
        }
        
        function renderTree() {
            const container = document.getElementById('treeContainer');
            const roots = familyData.filter(p => !p.fatherId && !p.motherId);
            
            debug('Rendering tree, roots found:', roots.length);
            
            if (roots.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🌳</div><div class="empty-state-text">No Family Tree Data</div></div>';
                return;
            }
            
            // Check if anyone has hidden their top - they become the new root instead
            let actualRoot = null;
            hiddenDirections.forEach((dirs, personId) => {
                if (dirs.top && !actualRoot) {
                    actualRoot = personMap[personId];
                }
            });
            
            // If there's a selected person, find their root ancestor
            let selectedRoot = null;
            if (selectedPerson) {
                let current = selectedPerson;
                while (current.fatherId || current.motherId) {
                    const parent = personMap[current.fatherId] || personMap[current.motherId];
                    if (!parent) break;
                    current = parent;
                }
                selectedRoot = current;
                debug('Selected person ancestor:', selectedRoot.name);
            }
            
            // Sort roots by descendant count, then by birth year
            const rootsWithInfo = roots.map(root => ({
                root,
                descendants: countDescendants(root.id),
                born: parseInt(root.born) || 9999
            }));
            
            // Filter to only roots with at least 1 descendant
            const rootsWithDescendants = rootsWithInfo.filter(r => r.descendants > 0);
            
            rootsWithDescendants.sort((a, b) => {
                if (b.descendants !== a.descendants) return b.descendants - a.descendants;
                return a.born - b.born;
            });
            
            debug('Roots with descendants:', rootsWithDescendants.length);
            rootsWithDescendants.forEach((r, i) => {
                debug(`  ${i + 1}. ${r.root.name} - ${r.descendants} descendants, born ${r.root.born || '?'}`);
            });
            
            // Build HTML for all root families
            let allTreesHTML = '';
            
            rootsWithDescendants.forEach((rootInfo, index) => {
                const treeHTML = renderMobileTree(rootInfo.root);
                
                // Add separator line between families (except after the last one)
                const separator = index < rootsWithDescendants.length - 1 
                    ? '<div class="family-separator"></div>' 
                    : '';
                
                allTreesHTML += treeHTML + separator;
            });
            
            container.innerHTML = `<div class="tree-root mobile-vertical">${allTreesHTML}</div>`;
            debug('✅ Rendered', rootsWithDescendants.length, 'family trees');
        }
        
        function countDescendants(personId) {
            let count = 0;
            const children = getChildren(personId);
            count += children.length;
            children.forEach(child => {
                count += countDescendants(child.id);
            });
            return count;
        }
        
        function toggleSection(personId, direction, event) {
            event.stopPropagation();
            
            if (!hiddenDirections.has(personId)) {
                hiddenDirections.set(personId, { top: false, bottom: false, left: false, right: false });
            }
            
            const state = hiddenDirections.get(personId);
            state[direction] = !state[direction];
            
            renderTree();
        }
        
        function toggleCoupleChildren(personId, spouseId, event) {
            event.stopPropagation();
            
            // Initialize if needed
            if (!hiddenDirections.has(personId)) {
                hiddenDirections.set(personId, { top: false, bottom: false, left: false, right: false });
            }
            if (!hiddenDirections.has(spouseId)) {
                hiddenDirections.set(spouseId, { top: false, bottom: false, left: false, right: false });
            }
            
            // Check current state
            const personState = hiddenDirections.get(personId);
            const spouseState = hiddenDirections.get(spouseId);
            const currentlyHidden = personState.bottom || spouseState.bottom;
            
            // Toggle both - set them to the opposite of current state
            personState.bottom = !currentlyHidden;
            spouseState.bottom = !currentlyHidden;
            
            renderTree();
        }
        
        function buildNode(person, depth) {
            if (!person) return '';
            
            const spouse = person.spouseId ? personMap[person.spouseId] : null;
            const children = getChildren(person.id);
            const isSelected = selectedPerson && selectedPerson.id === person.id;
            const isRelationshipHighlight = relationshipMode && 
                ((relationshipPerson1 && relationshipPerson1.id === person.id) || 
                 (relationshipPerson2 && relationshipPerson2.id === person.id));
            
            // Determine if we should show children based on expanded nodes
            let shouldShowChildren = false;
            if (expandedNodes.size > 0) {
                shouldShowChildren = expandedNodes.has(person.id) || (spouse && expandedNodes.has(spouse.id));
            } else {
                shouldShowChildren = depth < maxDepth;
            }
            
            const personCard = (p, selected, highlight) => {
                const imgUrl = p.imageId ? `https://lh3.googleusercontent.com/d/${p.imageId}` : '';
                let cardDates = '';
                if (p.born) cardDates += p.born;
                if (p.until) cardDates += ` - ${p.until}`;
                
                const highlightClass = highlight ? 'relationship-highlight' : '';
                const isBloodRelative = p.fatherId || p.motherId;
                const relativeType = isBloodRelative ? 'blood-relative' : 'married-in';
                const relativeLabel = isBloodRelative ? 'Blood' : 'Married In';
                
                // Get direction states for this person
                const dirs = hiddenDirections.get(p.id) || { top: false, bottom: false, left: false, right: false };
                
                // Determine which buttons to show
                const hasParent = p.fatherId || p.motherId;
                const hasChildren = getChildren(p.id).length > 0;
                const hasSpouse = p.spouseId;
                
                let buttonsHtml = '';
                
                // Top button - hide parent connection
                if (hasParent) {
                    buttonsHtml += `<div class="direction-toggle top ${dirs.top ? 'disabled' : ''}" onclick="toggleSection(${p.id}, 'top', event)" title="Toggle parents">↑</div>`;
                }
                
                // Bottom button - hide children
                if (hasChildren) {
                    buttonsHtml += `<div class="direction-toggle bottom ${dirs.bottom ? 'disabled' : ''}" onclick="toggleSection(${p.id}, 'bottom', event)" title="Toggle children">↓</div>`;
                }
                
                // Spouse buttons - blood relatives get right, married-in get left
                if (hasSpouse) {
                    const spouse = personMap[p.spouseId];
                    const isBlood = p.fatherId || p.motherId;
                    const spouseIsBlood = spouse && (spouse.fatherId || spouse.motherId);
                    
                    if (isBlood && !spouseIsBlood) {
                        // This person is blood, spouse married in - show RIGHT button to hide spouse
                        buttonsHtml += `<div class="direction-toggle right ${dirs.right ? 'disabled' : ''}" onclick="toggleSection(${p.id}, 'right', event)" title="Toggle spouse">→</div>`;
                    } else if (!isBlood && spouseIsBlood) {
                        // This person married in - show LEFT button to disconnect from spouse
                        buttonsHtml += `<div class="direction-toggle left ${dirs.left ? 'disabled' : ''}" onclick="toggleSection(${p.id}, 'left', event)" title="Disconnect">←</div>`;
                    } else if (!isBlood && !spouseIsBlood) {
                        // Both are root nodes - give both a button to hide their spouse
                        // First person (typically listed first) gets right button
                        // Second person gets left button
                        if (p.id < spouse.id) {
                            buttonsHtml += `<div class="direction-toggle right ${dirs.right ? 'disabled' : ''}" onclick="toggleSection(${p.id}, 'right', event)" title="Toggle spouse">→</div>`;
                        } else {
                            buttonsHtml += `<div class="direction-toggle left ${dirs.left ? 'disabled' : ''}" onclick="toggleSection(${p.id}, 'left', event)" title="Toggle spouse">←</div>`;
                        }
                    }
                }
                
return `
                    <div class="node-card ${p.sex.toLowerCase()} ${selected ? 'selected' : ''} ${highlightClass}" onclick="selectPerson(${p.id})">
                        ${buttonsHtml}
                        ${imgUrl ? `<img src="${imgUrl}" alt="${p.name}" class="node-image" onerror="this.style.display='none'">` : ''}
                        <div class="node-name" title="${p.name}">${p.name}</div>
                        ${cardDates ? `<div class="node-dates">${cardDates}</div>` : ''}
                        <div class="node-badges">
                            <span class="node-badge ${p.sex.toLowerCase()}">${p.sex}</span>
                            <span class="node-badge ${relativeType}">${relativeLabel}</span>
                            <span class="node-badge gen">G${p.generation}</span>
                        </div>
                    </div>
                `;
            };
            
            // Determine who is the blood relative
            const personIsBlood = person.fatherId || person.motherId;
            const spouseIsBlood = spouse && (spouse.fatherId || spouse.motherId);
            
            // Build class list for tree-node
            let nodeClasses = 'tree-node';
            let bloodPosition = '';
            
            if (spouse) {
                if (personIsBlood && !spouseIsBlood) {
                    nodeClasses += ' has-blood-parent blood-on-left';
                    bloodPosition = 'left';
                } else if (!personIsBlood && spouseIsBlood) {
                    nodeClasses += ' has-blood-parent blood-on-right';
                    bloodPosition = 'right';
                } else if (personIsBlood && spouseIsBlood) {
                    nodeClasses += ' has-blood-parent';
                }
            } else if (personIsBlood) {
                nodeClasses += ' has-blood-parent';
            }
            
            let html = `<div class="${nodeClasses}">`;
            
            if (spouse) {
                const spouseHighlight = relationshipMode && 
                    ((relationshipPerson1 && relationshipPerson1.id === spouse.id) || 
                     (relationshipPerson2 && relationshipPerson2.id === spouse.id));
                
                // Check if spouse should be hidden
                const personDirs = hiddenDirections.get(person.id) || { top: false, bottom: false, left: false, right: false };
                const spouseDirs = hiddenDirections.get(spouse.id) || { top: false, bottom: false, left: false, right: false };
                
                // Determine who is blood
                const personIsBloodInPair = person.fatherId || person.motherId;
                const spouseIsBloodInPair = spouse.fatherId || spouse.motherId;
                
                let hideLeftPerson = false;
                let hideRightPerson = false;
                
                if (personIsBloodInPair && !spouseIsBloodInPair) {
                    // Person is blood (left), spouse married in (right)
                    // Person's right button hides spouse
                    // Spouse's left button hides person
                    hideRightPerson = personDirs.right;
                    hideLeftPerson = spouseDirs.left;
                } else if (!personIsBloodInPair && spouseIsBloodInPair) {
                    // Spouse is blood (left), person married in (right)
                    // Spouse's right button hides person
                    // Person's left button hides spouse
                    hideRightPerson = spouseDirs.right;
                    hideLeftPerson = personDirs.left;
                } else if (!personIsBloodInPair && !spouseIsBloodInPair) {
                    // Both are root nodes - use ID to determine position
                    // Lower ID on left, higher ID on right
                    if (person.id < spouse.id) {
                        // Person on left, spouse on right
                        hideRightPerson = personDirs.right;
                        hideLeftPerson = spouseDirs.left;
                    } else {
                        // Spouse on left, person on right
                        hideRightPerson = spouseDirs.right;
                        hideLeftPerson = personDirs.left;
                    }
                }
                
                // Arrange with blood relative on left (or lower ID for root couples)
                let leftPerson, rightPerson, leftSelected, rightSelected, leftHighlight, rightHighlight;
                
                if (bloodPosition === 'right') {
                    leftPerson = spouse;
                    rightPerson = person;
                    leftSelected = selectedPerson && selectedPerson.id === spouse.id;
                    rightSelected = isSelected;
                    leftHighlight = spouseHighlight;
                    rightHighlight = isRelationshipHighlight;
                } else {
                    leftPerson = person;
                    rightPerson = spouse;
                    leftSelected = isSelected;
                    rightSelected = selectedPerson && selectedPerson.id === spouse.id;
                    leftHighlight = isRelationshipHighlight;
                    rightHighlight = spouseHighlight;
                }
                
                html += '<div class="spouse-pair">';
                if (!hideLeftPerson) {
                    html += personCard(leftPerson, leftSelected, leftHighlight);
                }
                if (!hideLeftPerson && !hideRightPerson) {
                    // Check if children are hidden by either spouse
                    const bothDirs = hiddenDirections.get(person.id) || { top: false, bottom: false, left: false, right: false };
                    const bothSpouseDirs = hiddenDirections.get(spouse.id) || { top: false, bottom: false, left: false, right: false };
                    const coupleChildrenHidden = bothDirs.bottom || bothSpouseDirs.bottom;
                    const toggleIcon = coupleChildrenHidden ? '+' : '−';
                    const toggleClass = coupleChildrenHidden ? 'disabled' : '';
                    
                    html += `<div class="spouse-connector">
                        <div class="spouse-connector-toggle ${toggleClass}" onclick="toggleCoupleChildren(${person.id}, ${spouse.id}, event)" title="${coupleChildrenHidden ? 'Show children' : 'Hide children'}">${toggleIcon}</div>
                    </div>`;
                }
                if (!hideRightPerson) {
                    html += personCard(rightPerson, rightSelected, rightHighlight);
                }
                html += '</div>';
            } else {
                html += personCard(person, isSelected, isRelationshipHighlight);
            }
            
            // Only show children if not hidden by bottom toggle
            const dirs = hiddenDirections.get(person.id) || { top: false, bottom: false, left: false, right: false };
            const spouseDirsForChildren = spouse ? (hiddenDirections.get(spouse.id) || { top: false, bottom: false, left: false, right: false }) : { top: false, bottom: false, left: false, right: false };
            
            // Hide children if either person OR spouse has clicked bottom button
            const childrenHidden = dirs.bottom || spouseDirsForChildren.bottom;
            
            if (children.length > 0 && shouldShowChildren && !childrenHidden && depth < 15) {
                html += '<div class="tree-children">';
                
                children.forEach(child => {
                    html += buildNode(child, depth + 1);
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        // Mobile sidebar toggle
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('mobileSidebar');
            const overlay = document.querySelector('.mobile-overlay');
            const isOpen = sidebar.classList.contains('mobile-open');
            
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
            
            // Toggle body class to disable tree interaction
            if (isOpen) {
                document.body.classList.remove('sidebar-open');
            } else {
                document.body.classList.add('sidebar-open');
            }
        }
        
        function closeMobileSidebarIfNeeded() {
            const sidebar = document.getElementById('mobileSidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            // Close sidebar after action
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            document.body.classList.remove('sidebar-open');
        }
        
        function resetView() {
            selectedPerson = null;
            expandedNodes.clear();
            hiddenDirections.clear(); // Clear all hidden junction directions
            maxDepth = 2;
            renderTree();
            
            // Clear main search bar
            const searchInput = document.getElementById('mainSearchInput');
            if (searchInput) {
                searchInput.value = '';
                filterTreeBySearch('');
            }
        }
        
        function expandAll() {
            if (isMobileView()) {
                expandAllMobile();
            } else {
                familyData.forEach(p => expandedNodes.add(p.id));
                maxDepth = 10;
                renderTree();
            }
        }
        
        function collapseAll() {
            if (isMobileView()) {
                collapseAllMobile();
            } else if (selectedPerson) {
                // Show condensed view of selected person
                expandedNodes.clear();
                
                // Add just the selected person and their immediate family
                expandedNodes.add(selectedPerson.id);
                if (selectedPerson.spouseId) {
                    expandedNodes.add(selectedPerson.spouseId);
                }
                
                // Add parents
                if (selectedPerson.fatherId) {
                    expandedNodes.add(selectedPerson.fatherId);
                    const father = personMap[selectedPerson.fatherId];
                    if (father && father.spouseId) {
                        expandedNodes.add(father.spouseId);
                    }
                }
                if (selectedPerson.motherId) {
                    expandedNodes.add(selectedPerson.motherId);
                }
                
                // Add siblings
                const siblings = getSiblings(selectedPerson);
                siblings.forEach(s => {
                    expandedNodes.add(s.id);
                    if (s.spouseId) expandedNodes.add(s.spouseId);
                });
                
                // Add children (one level only)
                const children = getChildren(selectedPerson.id);
                children.forEach(child => {
                    expandedNodes.add(child.id);
                    if (child.spouseId) expandedNodes.add(child.spouseId);
                });
                
                // Add the full ancestor path so the tree can render from root to selected person
                let current = selectedPerson;
                while (current.fatherId || current.motherId) {
                    const parent = personMap[current.fatherId] || personMap[current.motherId];
                    if (!parent) break;
                    expandedNodes.add(parent.id);
                    if (parent.spouseId) expandedNodes.add(parent.spouseId);
                    current = parent;
                }
                
                maxDepth = 1;
                renderTree();
            } else {
                // No person selected, just collapse to minimal depth
                expandedNodes.clear();
                maxDepth = 1;
                renderTree();
            }
        }
        
        console.log('✅ PHASE 4: All helper functions loaded successfully!');
        console.log('   personMap created:', Object.keys(personMap).length, 'people');
        console.log('   Generations calculated');
        
        // PHASE 5B: Enable renderTree (which calls renderMobileTree)
        console.log('🧪 PHASE 5B: Testing renderTree → renderMobileTree...');
        
        try {
            displayPeopleList();
            console.log('✅ displayPeopleList completed');
            
            console.log('🎯 About to call renderTree()...');
            console.log('   Container exists?', !!document.getElementById('treeContainer'));
            console.log('   familyData length:', familyData.length);
            console.log('   personMap size:', Object.keys(personMap).length);
            
            renderTree();
            
            console.log('✅ PHASE 5B: renderTree completed! (renderMobileTree worked!)');
        } catch (error) {
            console.error('❌ renderTree failed:', error.message, error.stack);
            document.body.innerHTML = `
                <div style="padding: 20px; background: #1a1a1a; color: #fff; font-family: sans-serif;">
                    <h1 style="color: #ff6b6b;">Phase 5B Failed: renderTree/renderMobileTree Error</h1>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Stack:</strong></p>
                    <pre style="background: #000; padding: 10px; overflow: auto; font-size: 11px;">${error.stack}</pre>
                </div>
            `;
        }
        
        // REST STILL COMMENTED OUT
        /*
        
        // ===== DATA MANAGER FUNCTIONS =====
        
        let currentEditingPerson = null;
        
        function openDataManager() {
            debug('🔓 openDataManager() called');
            
            // Close sidebar first to avoid overlap
            closeMobileSidebarIfNeeded();
            
            const modal = document.getElementById('dataManagerModal');
            modal.classList.add('active');
            
            // Override inline styles with important flag
            modal.style.setProperty('display', 'flex', 'important');
            modal.style.setProperty('visibility', 'visible', 'important');
            modal.style.setProperty('opacity', '1', 'important');
            
            switchTab('browse');
            refreshPeopleList();
            populateParentSpouseDropdowns();
        }
        
        function closeDataManager() {
            debug('🔒 closeDataManager() called');
            const modal = document.getElementById('dataManagerModal');
            modal.classList.remove('active');
            // Restore hidden inline styles
            modal.style.setProperty('display', 'none', 'important');
            modal.style.setProperty('visibility', 'hidden', 'important');
            modal.style.setProperty('opacity', '0', 'important');
            currentEditingPerson = null;
        }
        
        // Theme Selector Functions
        function openThemeSelector() {
            const modal = document.getElementById('themeSelectorModal');
            modal.style.setProperty('display', 'flex', 'important');
            modal.style.setProperty('visibility', 'visible', 'important');
            modal.style.setProperty('opacity', '1', 'important');
        }
        
        function closeThemeSelector() {
            const modal = document.getElementById('themeSelectorModal');
            modal.style.setProperty('display', 'none', 'important');
            modal.style.setProperty('visibility', 'hidden', 'important');
            modal.style.setProperty('opacity', '0', 'important');
        }
        
        function applyTheme(themeName) {
            const root = document.documentElement;
            
            const themes = {
                current: {
                    '--bark-900': '#1a1a1a',
                    '--bark-800': '#2d2d2d',
                    '--bark-700': '#3d3d3d',
                    '--gold-500': '#f4a261',
                    '--gold-400': '#f6b888',
                    '--gold-300': '#ffd4a3',
                    '--sage-500': '#6c9a8b',
                    '--sage-400': '#a8c5b5',
                    '--rose-500': '#ff6b9d',
                    '--rose-400': '#ffb3cc',
                    '--cream': '#f5f5f5',
                    '--parchment': '#e8e8e8',
                    '--blue-500': '#4a9eff'
                },
                forest: {
                    '--bark-900': '#1c2321',
                    '--bark-800': '#2d3b35',
                    '--bark-700': '#3d4d45',
                    '--gold-500': '#c9a86a',
                    '--gold-400': '#d4b88f',
                    '--gold-300': '#e5d4b5',
                    '--sage-500': '#5a9d8e',
                    '--sage-400': '#7db5a6',
                    '--rose-500': '#b87d6f',
                    '--rose-400': '#c99589',
                    '--cream': '#f5f1e8',
                    '--parchment': '#e8e3d8',
                    '--blue-500': '#5a9d8e'
                },
                ocean: {
                    '--bark-900': '#0f1419',
                    '--bark-800': '#1a2332',
                    '--bark-700': '#253447',
                    '--gold-500': '#ffc857',
                    '--gold-400': '#ffd77a',
                    '--gold-300': '#ffe9a3',
                    '--sage-500': '#00b4d8',
                    '--sage-400': '#33c4e0',
                    '--rose-500': '#f72585',
                    '--rose-400': '#f954a0',
                    '--cream': '#f0f4f8',
                    '--parchment': '#e1e9f0',
                    '--blue-500': '#00b4d8'
                },
                royal: {
                    '--bark-900': '#1a0f2e',
                    '--bark-800': '#2d1f47',
                    '--bark-700': '#3f2e5b',
                    '--gold-500': '#daa520',
                    '--gold-400': '#e6b84f',
                    '--gold-300': '#f2d087',
                    '--sage-500': '#6c5ce7',
                    '--sage-400': '#8b7ceb',
                    '--rose-500': '#fd79a8',
                    '--rose-400': '#fd96ba',
                    '--cream': '#faf8f3',
                    '--parchment': '#f0ede5',
                    '--blue-500': '#6c5ce7'
                },
                slate: {
                    '--bark-900': '#1e1e1e',
                    '--bark-800': '#2e2e2e',
                    '--bark-700': '#3e3e3e',
                    '--gold-500': '#00d9a0',
                    '--gold-400': '#33e2b3',
                    '--gold-300': '#66ebc6',
                    '--sage-500': '#4dabf7',
                    '--sage-400': '#70bbf9',
                    '--rose-500': '#ff6b9d',
                    '--rose-400': '#ff8fb3',
                    '--cream': '#f8f9fa',
                    '--parchment': '#e9ecef',
                    '--blue-500': '#4dabf7'
                },
                sunset: {
                    '--bark-900': '#1a1312',
                    '--bark-800': '#2d221f',
                    '--bark-700': '#3d302a',
                    '--gold-500': '#ff9a56',
                    '--gold-400': '#ffb380',
                    '--gold-300': '#ffccaa',
                    '--sage-500': '#5dade2',
                    '--sage-400': '#7dbfe6',
                    '--rose-500': '#ec7063',
                    '--rose-400': '#f08d82',
                    '--cream': '#fff5ee',
                    '--parchment': '#f5e9e0',
                    '--blue-500': '#5dade2'
                }
            };
            
            const theme = themes[themeName];
            if (theme) {
                // Apply all color variables
                Object.keys(theme).forEach(key => {
                    root.style.setProperty(key, theme[key]);
                });
                
                // Save theme preference
                localStorage.setItem('selectedTheme', themeName);
                
                console.log(`✨ Applied theme: ${themeName}`);
                
                // Show confirmation
                const modal = document.getElementById('themeSelectorModal');
                const confirmMsg = document.createElement('div');
                confirmMsg.textContent = '✓ Theme applied!';
                confirmMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--gold-500); color: var(--bark-900); padding: 12px 24px; border-radius: 8px; font-weight: 600; z-index: 999999; animation: slideIn 0.3s;';
                document.body.appendChild(confirmMsg);
                setTimeout(() => confirmMsg.remove(), 2000);
            }
        }
        
        // Load saved theme on page load
        window.addEventListener('load', function() {
            const savedTheme = localStorage.getItem('selectedTheme');
            if (savedTheme) {
                applyTheme(savedTheme);
            }
        });
        
        // Re-render tree on window resize (mobile <-> desktop)
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                renderTree();
            }, 250);
        });
        
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.data-tab').forEach(tab => tab.classList.remove('active'));
            if (event && event.target && event.target.classList) {
                event.target.classList.add('active');
            }
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'browse') {
                document.getElementById('browseTab').classList.add('active');
                document.querySelectorAll('.data-tab')[0].classList.add('active');
                refreshPeopleList();
            } else if (tabName === 'add') {
                document.getElementById('addTab').classList.add('active');
                document.querySelectorAll('.data-tab')[1].classList.add('active');
                populateParentSpouseDropdowns();
            } else if (tabName === 'edit') {
                document.getElementById('editTab').classList.add('active');
                document.querySelectorAll('.data-tab')[2].classList.add('active');
            } else if (tabName === 'import-export') {
                document.getElementById('importExportTab').classList.add('active');
                document.querySelectorAll('.data-tab')[3].classList.add('active');
            }
        }
        
        function refreshPeopleList() {
            document.getElementById('searchPeople').value = ''; // Clear search
            filterPeopleList();
        }
        
        function filterPeopleList() {
            const searchTerm = document.getElementById('searchPeople').value.toLowerCase();
            const container = document.getElementById('peopleList');
            container.innerHTML = '';
            
            const sortedPeople = [...familyData].sort((a, b) => a.name.localeCompare(b.name));
            
            // Filter by search term
            const filteredPeople = searchTerm 
                ? sortedPeople.filter(p => p.name.toLowerCase().includes(searchTerm))
                : sortedPeople;
            
            if (filteredPeople.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--gold-300); padding: 40px;">No matches found</div>';
                return;
            }
            
            filteredPeople.forEach(person => {
                const spouse = person.spouseId ? personMap[person.spouseId] : null;
                const father = person.fatherId ? personMap[person.fatherId] : null;
                const mother = person.motherId ? personMap[person.motherId] : null;
                
                const details = [];
                if (person.born) details.push(`Born: ${person.born}`);
                if (spouse) details.push(`Spouse: ${spouse.name}`);
                if (father || mother) {
                    const parents = [father ? father.name : null, mother ? mother.name : null].filter(Boolean).join(' & ');
                    details.push(`Parents: ${parents}`);
                }
                
                const div = document.createElement('div');
                div.className = 'person-item';
                div.onclick = () => selectPersonForEdit(person);
                div.innerHTML = `
                    <div class="person-item-name">${person.name} (ID: ${person.id})</div>
                    <div class="person-item-details">${person.sex}${details.length ? ' • ' + details.join(' • ') : ''}</div>
                `;
                container.appendChild(div);
            });
        }
        
        function selectPersonForEdit(person) {
            currentEditingPerson = person;
            switchTab('edit');
            
            // Show form and populate
            document.getElementById('editMessage').style.display = 'none';
            document.getElementById('editFormContainer').style.display = 'block';
            
            populateParentSpouseDropdowns('edit');
            
            document.getElementById('editId').value = person.id;
            document.getElementById('editName').value = person.name;
            document.getElementById('editSex').value = person.sex;
            document.getElementById('editBorn').value = person.born || '';
            document.getElementById('editUntil').value = person.until || '';
            document.getElementById('editFather').value = person.fatherId || '';
            document.getElementById('editMother').value = person.motherId || '';
            document.getElementById('editSpouse').value = person.spouseId || '';
            document.getElementById('editImageId').value = person.imageId || '';
        }
        
        function populateParentSpouseDropdowns(prefix = 'add') {
            const males = familyData.filter(p => p.sex === 'Male').sort((a, b) => a.name.localeCompare(b.name));
            const females = familyData.filter(p => p.sex === 'Female').sort((a, b) => a.name.localeCompare(b.name));
            
            // Father dropdown (males)
            const fatherSelect = document.getElementById(prefix + 'Father');
            fatherSelect.innerHTML = '<option value="">None</option>';
            males.forEach(p => {
                fatherSelect.innerHTML += `<option value="${p.id}">${p.name} (ID: ${p.id})</option>`;
            });
            
            // Mother dropdown (females)
            const motherSelect = document.getElementById(prefix + 'Mother');
            motherSelect.innerHTML = '<option value="">None</option>';
            females.forEach(p => {
                motherSelect.innerHTML += `<option value="${p.id}">${p.name} (ID: ${p.id})</option>`;
            });
            
            // Spouse dropdown (all)
            const spouseSelect = document.getElementById(prefix + 'Spouse');
            spouseSelect.innerHTML = '<option value="">None</option>';
            familyData.sort((a, b) => a.name.localeCompare(b.name)).forEach(p => {
                spouseSelect.innerHTML += `<option value="${p.id}">${p.name} (${p.sex}, ID: ${p.id})</option>`;
            });
        }
        
        function addPerson() {
            const name = document.getElementById('addName').value.trim();
            const sex = document.getElementById('addSex').value;
            
            if (!name) {
                alert('Name is required!');
                return;
            }
            
            // Find next available ID
            const maxId = Math.max(...familyData.map(p => p.id));
            const newId = maxId + 1;
            
            const newPerson = {
                id: newId,
                name: name,
                sex: sex,
                born: document.getElementById('addBorn').value.trim(),
                until: document.getElementById('addUntil').value.trim(),
                spouseId: document.getElementById('addSpouse').value ? parseInt(document.getElementById('addSpouse').value) : null,
                fatherId: document.getElementById('addFather').value ? parseInt(document.getElementById('addFather').value) : null,
                motherId: document.getElementById('addMother').value ? parseInt(document.getElementById('addMother').value) : null,
                imageId: document.getElementById('addImageId').value.trim()
            };
            
            familyData.push(newPerson);
            personMap[newId] = newPerson;
            
            // Update spouse's spouseId if spouse was selected
            if (newPerson.spouseId) {
                const spouse = personMap[newPerson.spouseId];
                if (spouse) {
                    spouse.spouseId = newId;
                }
            }
            
            alert(`Added ${name} successfully!`);
            clearAddForm();
            refreshPeopleList();
            renderTree();
        }
        
        function clearAddForm() {
            document.getElementById('addName').value = '';
            document.getElementById('addSex').value = 'Male';
            document.getElementById('addBorn').value = '';
            document.getElementById('addUntil').value = '';
            document.getElementById('addFather').value = '';
            document.getElementById('addMother').value = '';
            document.getElementById('addSpouse').value = '';
            document.getElementById('addImageId').value = '';
        }
        
        function savePerson() {
            const id = parseInt(document.getElementById('editId').value);
            const person = personMap[id];
            
            if (!person) return;
            
            const oldSpouseId = person.spouseId;
            
            person.name = document.getElementById('editName').value.trim();
            person.sex = document.getElementById('editSex').value;
            person.born = document.getElementById('editBorn').value.trim();
            person.until = document.getElementById('editUntil').value.trim();
            person.fatherId = document.getElementById('editFather').value ? parseInt(document.getElementById('editFather').value) : null;
            person.motherId = document.getElementById('editMother').value ? parseInt(document.getElementById('editMother').value) : null;
            person.spouseId = document.getElementById('editSpouse').value ? parseInt(document.getElementById('editSpouse').value) : null;
            person.imageId = document.getElementById('editImageId').value.trim();
            
            // Update spouse relationships
            if (oldSpouseId && oldSpouseId !== person.spouseId) {
                const oldSpouse = personMap[oldSpouseId];
                if (oldSpouse) oldSpouse.spouseId = null;
            }
            
            if (person.spouseId) {
                const newSpouse = personMap[person.spouseId];
                if (newSpouse) newSpouse.spouseId = id;
            }
            
            // Rebuild personMap to ensure consistency
            personMap = {};
            familyData.forEach(p => personMap[p.id] = p);
            
            // Update currentEditingPerson reference
            currentEditingPerson = personMap[id];
            
            alert('Changes saved!');
            refreshPeopleList();
            filterPeople(); // Update the main sidebar list
            renderTree(); // Redraw the tree
        }
        
        function deletePerson() {
            if (!currentEditingPerson) return;
            
            if (!confirm(`Are you sure you want to delete ${currentEditingPerson.name}? This cannot be undone.`)) {
                return;
            }
            
            const id = currentEditingPerson.id;
            
            // Remove from array
            familyData = familyData.filter(p => p.id !== id);
            delete personMap[id];
            
            // Clean up references
            familyData.forEach(p => {
                if (p.spouseId === id) p.spouseId = null;
                if (p.fatherId === id) p.fatherId = null;
                if (p.motherId === id) p.motherId = null;
            });
            
            alert('Person deleted.');
            document.getElementById('editFormContainer').style.display = 'none';
            document.getElementById('editMessage').style.display = 'block';
            currentEditingPerson = null;
            refreshPeopleList();
            renderTree();
        }
        
        function exportJSON() {
            const dataStr = JSON.stringify(familyData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'family_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportCSV() {
            const headers = ['ID', 'Name', 'Sex', 'Born', 'Until', 'Spouse ID', 'Father ID', 'Mother ID', 'Image ID'];
            const rows = familyData.map(p => [
                p.id,
                p.name,
                p.sex,
                p.born || '',
                p.until || '',
                p.spouseId || '',
                p.fatherId || '',
                p.motherId || '',
                p.imageId || ''
            ]);
            
            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'family_data.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportForGoogleSheets() {
            // Create CSV with ORIGINAL 13-column format to match the source data
            const headers = ['Person ID', 'Person Name', 'Sex', 'Born', 'Until', 'Spouse ID', 'Spouse Name', 'Father ID', "Father's Name", 'Mother ID', "Mother's Name", 'Image ID', 'Group ID'];
            
            // Sort by Person ID before exporting
            const sortedData = [...familyData].sort((a, b) => a.id - b.id);
            
            const rows = sortedData.map(p => {
                const spouse = p.spouseId ? personMap[p.spouseId] : null;
                const father = p.fatherId ? personMap[p.fatherId] : null;
                const mother = p.motherId ? personMap[p.motherId] : null;
                
                return [
                    p.id,                                    // Column 0: Person ID
                    p.name,                                  // Column 1: Person Name
                    p.sex,                                   // Column 2: Sex
                    p.born || '',                            // Column 3: Born
                    p.until || '',                           // Column 4: Until
                    p.spouseId || '',                        // Column 5: Spouse ID
                    spouse ? spouse.name : '',               // Column 6: Spouse Name
                    p.fatherId || '',                        // Column 7: Father ID
                    father ? father.name : '',               // Column 8: Father's Name
                    p.motherId || '',                        // Column 9: Mother ID
                    mother ? mother.name : '',               // Column 10: Mother's Name
                    p.imageId || '',                         // Column 11: Image ID
                    'G' + p.id + (p.spouseId || '')          // Column 12: Group ID
                ];
            });
            
            const csv = [headers, ...rows].map(row => row.map(cell => {
                // Escape quotes and wrap in quotes
                const cellStr = String(cell).replace(/"/g, '""');
                return `"${cellStr}"`;
            }).join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'family_tree_for_google_sheets.csv';
            a.click();
            URL.revokeObjectURL(url);
            
            // Show instructions
            alert('CSV downloaded!\n\nNext steps:\n1. Go to Google Sheets (or create new one)\n2. File → Import → Upload\n3. Upload this CSV file\n4. Choose "Replace spreadsheet" or "Replace current sheet"\n5. Share the sheet (Anyone with link can view)\n6. Copy the URL and paste it in the Import/Export tab!\n\nFormat: 13 columns matching original data structure.');
        }
        
        function copyToClipboard() {
            const dataStr = JSON.stringify(familyData, null, 2);
            navigator.clipboard.writeText(dataStr).then(() => {
                alert('JSON data copied to clipboard!');
            });
        }
        
        function showImportTextArea() {
            document.getElementById('importTextAreaContainer').style.display = 'block';
        }
        
        function hideImportTextArea() {
            document.getElementById('importTextAreaContainer').style.display = 'none';
            document.getElementById('importTextArea').value = '';
        }
        
        function importFromText() {
            const text = document.getElementById('importTextArea').value.trim();
            if (!text) {
                alert('Please paste JSON data first!');
                return;
            }
            
            try {
                const data = JSON.parse(text);
                if (!Array.isArray(data)) {
                    alert('Invalid format! Data must be an array of people.');
                    return;
                }
                
                if (!confirm('This will replace ALL current data. Continue?')) {
                    return;
                }
                
                familyData = data;
                personMap = {};
                familyData.forEach(p => personMap[p.id] = p);
                
                alert('Data imported successfully!');
                hideImportTextArea();
                refreshPeopleList();
                renderTree();
            } catch (e) {
                alert('Invalid JSON! Error: ' + e.message);
            }
        }
        
        function importData() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                
                try {
                    let data;
                    if (file.name.endsWith('.json')) {
                        data = JSON.parse(content);
                    } else if (file.name.endsWith('.csv')) {
                        data = parseCSV(content);
                    } else {
                        alert('Unsupported file type!');
                        return;
                    }
                    
                    if (!Array.isArray(data)) {
                        alert('Invalid format!');
                        return;
                    }
                    
                    if (!confirm('This will replace ALL current data. Continue?')) {
                        return;
                    }
                    
                    familyData = data;
                    personMap = {};
                    familyData.forEach(p => personMap[p.id] = p);
                    
                    alert('Data imported successfully!');
                    refreshPeopleList();
                    renderTree();
                } catch (e) {
                    alert('Error importing file: ' + e.message);
                }
            };
            reader.readAsText(file);
        }
        
        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.replace(/"/g, '').trim());
                return {
                    id: parseInt(values[0]) || 0,
                    name: values[1] || '',
                    sex: values[2] || 'Male',
                    born: values[3] || '',
                    until: values[4] || '',
                    spouseId: values[5] ? parseInt(values[5]) : null,
                    fatherId: values[6] ? parseInt(values[6]) : null,
                    motherId: values[7] ? parseInt(values[7]) : null,
                    imageId: values[8] || ''
                };
            });
        }
        
        // ===== GOOGLE SHEETS INTEGRATION =====
        
        function getSheetIdFromUrl(url) {
            // Extract sheet ID from Google Sheets URL
            const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
        }
        
        function loadFromGoogleSheets() {
            const url = document.getElementById('googleSheetUrl').value.trim();
            if (!url) {
                alert('Please enter a Google Sheets URL first!');
                return;
            }
            
            const sheetId = getSheetIdFromUrl(url);
            if (!sheetId) {
                alert('Invalid Google Sheets URL!');
                return;
            }
            
            // Save the URL for future use
            localStorage.setItem('googleSheetUrl', url);
            
            document.getElementById('sheetsStatus').innerHTML = '⏳ Loading from Google Sheets...';
            
            // Use the public CSV export URL with gid=0 for first sheet
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
            
            fetch(csvUrl, {
                mode: 'cors',
                headers: {
                    'Accept': 'text/csv'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: Make sure the sheet is shared as "Anyone with the link can view"`);
                    }
                    return response.text();
                })
                .then(csvData => {
                    debug('✅ CSV Data received, length:', csvData.length);
                    console.log('CSV preview:', csvData.substring(0, 200));
                    
                    const data = parseGoogleSheetCSV(csvData);
                    
                    if (!data || data.length === 0) {
                        throw new Error('No valid data found in sheet. Check that column order matches: Person ID, Person Name, Sex, Born, Until, Spouse ID, Spouse Name, Father ID, Father\'s Name, Mother ID, Mother\'s Name, Image ID, Group ID');
                    }
                    
                    debug('📊 Parsed data count:', data.length);
                    debug('📊 About to assign familyData...');
                    
                    // Update the family data
                    familyData = data;
                    debug('✅ familyData assigned successfully');
                    
                    personMap = {};
                    debug('✅ personMap cleared');
                    
                    familyData.forEach(p => personMap[p.id] = p);
                    debug('✅ personMap rebuilt with', Object.keys(personMap).length, 'people');
                    
                    document.getElementById('sheetsStatus').innerHTML = `✅ Loaded ${data.length} people from Google Sheets!`;
                    
                    refreshPeopleList();
                    filterPeople(); // Refresh sidebar with new data
                    renderTree();
                    
                    setTimeout(() => {
                        document.getElementById('sheetsStatus').innerHTML = '';
                    }, 5000);
                })
                .catch(error => {
                    document.getElementById('sheetsStatus').innerHTML = `❌ Error: ${error.message}`;
                    console.error('Sheet load error:', error);
                    
                    // Show helpful troubleshooting
                    alert(`Failed to load from Google Sheets.\n\nTroubleshooting:\n1. Make sure sheet is shared as "Anyone with the link can view"\n2. Check that the URL is correct\n3. Verify the sheet has data in the correct format\n\nError: ${error.message}`);
                });
        }
        
        function parseGoogleSheetCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            debug('📋 Total lines in CSV:', lines.length);
            debug('📋 Header:', lines[0]);
            debug('📋 First data row:', lines[1]);
            
            // Skip header row
            const parsed = lines.slice(1).map((line, index) => {
                // Parse CSV properly (handle quotes)
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                // Debug first person
                if (index === 0) {
                    debug('📋 First person values:', values);
                    debug('📋 Number of columns:', values.length);
                    
                    // Detect format based on column count
                    if (values.length >= 13) {
                        debug('📋 Detected: ORIGINAL FORMAT (13 columns with names)');
                        debug('📋 Parsed first person:', {
                            id: parseInt(values[0]),
                            name: values[1],
                            sex: values[2],
                            spouseId: values[5],
                            fatherId: values[7],
                            motherId: values[9],
                            imageId: values[11]
                        });
                    } else {
                        debug('📋 Detected: SIMPLIFIED FORMAT (9 columns without names)');
                        debug('📋 Parsed first person:', {
                            id: parseInt(values[0]),
                            name: values[1],
                            sex: values[2],
                            spouseId: values[5],
                            fatherId: values[6],
                            motherId: values[7],
                            imageId: values[8]
                        });
                    }
                }
                
                // Map to data structure - support both formats
                let personData;
                if (values.length >= 13) {
                    // ORIGINAL FORMAT: Person ID, Person Name, Sex, Born, Until, Spouse ID, Spouse Name, Father ID, Father's Name, Mother ID, Mother's Name, Image ID, Group ID
                    personData = {
                        id: parseInt(values[0]) || 0,
                        name: values[1] || '',
                        sex: values[2] || 'Male',
                        born: values[3] || '',
                        until: values[4] || '',
                        spouseId: values[5] ? parseInt(values[5]) : null,
                        fatherId: values[7] ? parseInt(values[7]) : null,
                        motherId: values[9] ? parseInt(values[9]) : null,
                        imageId: values[11] || ''
                    };
                } else {
                    // SIMPLIFIED FORMAT: ID, Name, Sex, Born, Until, Spouse ID, Father ID, Mother ID, Image ID
                    personData = {
                        id: parseInt(values[0]) || 0,
                        name: values[1] || '',
                        sex: values[2] || 'Male',
                        born: values[3] || '',
                        until: values[4] || '',
                        spouseId: values[5] ? parseInt(values[5]) : null,
                        fatherId: values[6] ? parseInt(values[6]) : null,
                        motherId: values[7] ? parseInt(values[7]) : null,
                        imageId: values[8] || ''
                    };
                }
                
                return personData;
            }).filter(p => p.id > 0); // Filter out invalid rows
            
            debug('📊 Total parsed people:', parsed.length);
            debug('📊 Sample parsed data (first 5):');
            parsed.slice(0, 5).forEach(p => {
                console.log(`  - ID ${p.id}: ${p.name} | Father: ${p.fatherId || 'none'} | Mother: ${p.motherId || 'none'} | Spouse: ${p.spouseId || 'none'}`);
            });
            
            // Count roots
            const rootCount = parsed.filter(p => !p.fatherId && !p.motherId).length;
            debug('📊 People with no parents (roots):', rootCount);
            
            return parsed;
        }
        
        function saveToGoogleSheets() {
            alert('To save to Google Sheets:\n\n1. Export using "Export for Sheets" button\n2. In your Google Sheet, select all data\n3. Delete it\n4. File → Import → Upload the new CSV\n5. Choose "Replace current sheet"\n\nNote: Direct write access requires Google Sheets API setup, which we can add later if needed!');
        }
        
        function exportUpdatedHTML() {
            // Get the current HTML
            let htmlContent = document.documentElement.outerHTML;
            
            // Sort data by ID for consistency
            const sortedData = [...familyData].sort((a, b) => a.id - b.id);
            
            // Convert familyData to formatted JSON
            const dataJSON = JSON.stringify(sortedData, null, 12); // 12 spaces for indentation
            
            // Find and replace the familyData array in the HTML
            const dataStartMarker = 'let familyData = [';
            const dataEndMarker = '        ];';
            
            const startIndex = htmlContent.indexOf(dataStartMarker);
            if (startIndex === -1) {
                alert('Error: Could not find data section in HTML');
                return;
            }
            
            const endIndex = htmlContent.indexOf(dataEndMarker, startIndex);
            if (endIndex === -1) {
                alert('Error: Could not find end of data section');
                return;
            }
            
            // Replace the data section
            const beforeData = htmlContent.substring(0, startIndex + dataStartMarker.length);
            const afterData = htmlContent.substring(endIndex);
            
            // Format the JSON data array properly
            const formattedData = '\n' + dataJSON.substring(1, dataJSON.length - 1); // Remove outer brackets
            
            const newHTML = beforeData + formattedData + '\n        ' + afterData;
            
            // Download the file
            const blob = new Blob([newHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'family_tree_updated.html';
            a.click();
            URL.revokeObjectURL(url);
            
            alert('Updated HTML file downloaded!\n\nThis file has your current data baked in.\nUpload it to GitHub to replace the old version.');
        }
        
        // Load saved Google Sheet URL on page load
        // Auto-load data from project file on startup
        window.addEventListener('DOMContentLoaded', async () => {
            const savedUrl = localStorage.getItem('googleSheetUrl');
            if (savedUrl) {
                document.getElementById('googleSheetUrl').value = savedUrl;
            }
            
            // DEBUG: Check if modal has active class on load
            const modal = document.getElementById('dataManagerModal');
            if (modal) {
                debug('📋 Data Manager modal state on load:', {
                    hasActiveClass: modal.classList.contains('active'),
                    display: window.getComputedStyle(modal).display,
                    zIndex: window.getComputedStyle(modal).zIndex
                });
                
                // Force remove active class if present
                if (modal.classList.contains('active')) {
                    console.warn('⚠️ Modal had active class on load! Removing...');
                    modal.classList.remove('active');
                }
            }
            
            // DEBUG: Log all clicks to see what's being hit
            document.addEventListener('click', function(e) {
                const isSidebarOpen = document.body.classList.contains('sidebar-open');
                debug('🖱️ CLICK DEBUG:', {
                    'Sidebar Open': isSidebarOpen,
                    'Target': e.target.tagName,
                    'Class': e.target.className,
                    'Z-Index': window.getComputedStyle(e.target).zIndex,
                    'Pointer Events': window.getComputedStyle(e.target).pointerEvents
                });
            }, true);
            
            // DEBUG: Log scroll events
            window.addEventListener('scroll', function(e) {
                const isSidebarOpen = document.body.classList.contains('sidebar-open');
                if (isSidebarOpen) {
                    debug('📜 SCROLL while sidebar open - Target:', e.target.className);
                }
            }, true);
            
            // Complete event isolation for sidebar
            const sidebar = document.getElementById('mobileSidebar');
            const personListContainer = document.querySelector('.person-list-container');
            const treeCanvas = document.querySelector('.tree-canvas');
            
            if (sidebar && personListContainer && treeCanvas) {
                // Prevent scroll chaining from person-list to tree
                personListContainer.addEventListener('wheel', function(e) {
                    const isAtTop = personListContainer.scrollTop === 0;
                    const isAtBottom = personListContainer.scrollTop + personListContainer.clientHeight >= personListContainer.scrollHeight;
                    
                    // If scrolling up at top, or down at bottom, prevent default to stop propagation
                    if ((isAtTop && e.deltaY < 0) || (isAtBottom && e.deltaY > 0)) {
                        e.preventDefault();
                    }
                    e.stopPropagation();
                }, { passive: false });
                
                // Same for touch scroll
                let startY = 0;
                personListContainer.addEventListener('touchstart', function(e) {
                    startY = e.touches[0].pageY;
                }, { passive: true });
                
                personListContainer.addEventListener('touchmove', function(e) {
                    const currentY = e.touches[0].pageY;
                    const isAtTop = personListContainer.scrollTop === 0;
                    const isAtBottom = personListContainer.scrollTop + personListContainer.clientHeight >= personListContainer.scrollHeight;
                    
                    const isScrollingUp = currentY > startY;
                    const isScrollingDown = currentY < startY;
                    
                    if ((isAtTop && isScrollingUp) || (isAtBottom && isScrollingDown)) {
                        e.preventDefault();
                    }
                    e.stopPropagation();
                }, { passive: false });
                
                // Block ALL events on tree when sidebar is open
                const blockTreeEvents = function(e) {
                    if (document.body.classList.contains('sidebar-open')) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }
                };
                
                // Add to tree canvas with capture phase
                ['click', 'touchstart', 'touchmove', 'touchend', 'wheel', 'scroll', 'mousedown', 'mousemove', 'mouseup'].forEach(eventType => {
                    treeCanvas.addEventListener(eventType, blockTreeEvents, { capture: true, passive: false });
                });
            }
            
            // Try to load from project CSV file
            console.log('🔄 Attempting to load data from project file...');
            try {
                const response = await fetch('family_tree_for_google_sheets.csv');
                if (response.ok) {
                    const csvData = await response.text();
                    const data = parseGoogleSheetCSV(csvData);
                    
                    if (data && data.length > 0) {
                        debug('✅ Loaded', data.length, 'people from project CSV file');
                        familyData = data;
                        personMap = {};
                        familyData.forEach(p => personMap[p.id] = p);
                        
                        // Recalculate generations
                        familyData.forEach(p => {
                            p.generation = calculateGeneration(p);
                        });
                        
                        // Update UI
                        displayPeopleList();
                        renderTree();
                    } else {
                        console.log('⚠️ Project CSV file empty or invalid, using hardcoded data');
                    }
                } else {
                    debug('ℹ️ Project CSV file not found, using hardcoded data');
                }
            } catch (error) {
                debug('ℹ️ Could not load project CSV file, using hardcoded data:', error.message);
            }
        });
        
        // END OF ENABLED CODE - REST IS COMMENTED OUT
        */
    console.log('✅ PHASE 4 loaded successfully');
    </script>
    
    <!-- Version Info -->
    <div class="version-info">v5.5.7 - TEST: DEPTH 6</div>
    
    <!-- Data Manager Modal -->
    <div class="data-manager-modal" id="dataManagerModal" style="display: none; visibility: hidden; opacity: 0; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 200000;">
        <div class="data-manager-content">
            <div class="data-manager-header">
                <h2>Family Data Manager</h2>
                <button class="data-manager-close" onclick="closeDataManager()">×</button>
            </div>
            <div class="data-manager-body">
                <div class="data-manager-tabs">
                    <button class="data-tab active" onclick="switchTab('browse')">Browse People</button>
                    <button class="data-tab" onclick="switchTab('add')">Add Person</button>
                    <button class="data-tab" onclick="switchTab('edit')">Edit Person</button>
                    <button class="data-tab" onclick="switchTab('import-export')">Import/Export</button>
                </div>
                
                <!-- Browse Tab -->
                <div class="tab-content active" id="browseTab">
                    <div class="data-actions">
                        <div class="form-group" style="flex: 1; max-width: 400px; margin: 0;">
                            <input type="text" id="searchPeople" placeholder="Search by name..." 
                                   oninput="filterPeopleList()" 
                                   style="width: 100%; padding: 12px 20px; font-size: 16px;">
                        </div>
                        <button class="action-btn" onclick="refreshPeopleList()">Refresh</button>
                        <button class="action-btn secondary" onclick="switchTab('add')">Add New Person</button>
                    </div>
                    <div class="people-list" id="peopleList"></div>
                </div>
                
                <!-- Add Tab -->
                <div class="tab-content" id="addTab">
                    <div class="edit-form">
                        <h3 style="color: var(--gold-400); margin-top: 0;">Add New Person</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Name *</label>
                                <input type="text" id="addName" placeholder="Full name">
                            </div>
                            <div class="form-group">
                                <label>Sex *</label>
                                <select id="addSex">
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Born (Year)</label>
                                <input type="text" id="addBorn" placeholder="e.g., 1990">
                            </div>
                            <div class="form-group">
                                <label>Until (Year)</label>
                                <input type="text" id="addUntil" placeholder="Leave empty if alive">
                            </div>
                            <div class="form-group">
                                <label>Father</label>
                                <select id="addFather">
                                    <option value="">None</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Mother</label>
                                <select id="addMother">
                                    <option value="">None</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Spouse</label>
                                <select id="addSpouse">
                                    <option value="">None</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Image (Google Drive File ID)</label>
                                <input type="text" id="addImageId" placeholder="Optional">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="action-btn secondary" onclick="clearAddForm()">Clear</button>
                            <button class="action-btn" onclick="addPerson()">Add Person</button>
                        </div>
                    </div>
                </div>
                
                <!-- Edit Tab -->
                <div class="tab-content" id="editTab">
                    <div id="editMessage" style="color: var(--gold-300); text-align: center; padding: 20px;">
                        Select a person from the Browse tab to edit
                    </div>
                    <div class="edit-form" id="editFormContainer" style="display: none;">
                        <h3 style="color: var(--gold-400); margin-top: 0;">Edit Person</h3>
                        <input type="hidden" id="editId">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Name *</label>
                                <input type="text" id="editName">
                            </div>
                            <div class="form-group">
                                <label>Sex *</label>
                                <select id="editSex">
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Born (Year)</label>
                                <input type="text" id="editBorn">
                            </div>
                            <div class="form-group">
                                <label>Until (Year)</label>
                                <input type="text" id="editUntil">
                            </div>
                            <div class="form-group">
                                <label>Father</label>
                                <select id="editFather">
                                    <option value="">None</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Mother</label>
                                <select id="editMother">
                                    <option value="">None</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Spouse</label>
                                <select id="editSpouse">
                                    <option value="">None</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Image (Google Drive File ID)</label>
                                <input type="text" id="editImageId">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="action-btn secondary" onclick="deletePerson()" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">Delete</button>
                            <button class="action-btn" onclick="savePerson()">Save Changes</button>
                        </div>
                    </div>
                </div>
                
                <!-- Import/Export Tab -->
                <div class="tab-content" id="importExportTab">
                    <div class="import-export-area">
                        <h3>Google Sheets Integration</h3>
                        <p style="color: var(--gold-200); margin-bottom: 15px;">
                            Connect to a Google Sheet to sync your family data. Edit in Sheets or in this app!
                        </p>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Google Sheet URL (Public or Anyone with Link)</label>
                            <input type="text" id="googleSheetUrl" placeholder="https://docs.google.com/spreadsheets/d/..." 
                                   style="width: 100%;">
                        </div>
                        <div class="data-actions">
                            <button class="action-btn" onclick="exportForGoogleSheets()">Export for Sheets (Step 1)</button>
                            <button class="action-btn" onclick="loadFromGoogleSheets()">Load from Sheets</button>
                            <button class="action-btn" onclick="saveToGoogleSheets()">Save to Sheets</button>
                        </div>
                        <div id="sheetsStatus" style="margin-top: 10px; color: var(--gold-300); font-size: 14px;"></div>
                    </div>
                    
                    <div class="import-export-area" style="margin-top: 25px;">
                        <h3>Import Data</h3>
                        <p style="color: var(--gold-200); margin-bottom: 15px;">
                            Import family data from JSON or CSV file. This will replace all current data.
                        </p>
                        <div class="data-actions">
                            <div class="file-input-wrapper">
                                <button class="action-btn">Choose File</button>
                                <input type="file" id="importFile" accept=".json,.csv" onchange="importData()">
                            </div>
                            <button class="action-btn secondary" onclick="showImportTextArea()">Paste JSON</button>
                        </div>
                        <div id="importTextAreaContainer" style="display: none; margin-top: 20px;">
                            <textarea id="importTextArea" placeholder="Paste JSON data here..."></textarea>
                            <div class="form-actions" style="margin-top: 15px;">
                                <button class="action-btn secondary" onclick="hideImportTextArea()">Cancel</button>
                                <button class="action-btn" onclick="importFromText()">Import JSON</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="import-export-area" style="margin-top: 25px;">
                        <h3>Export Data</h3>
                        <p style="color: var(--gold-200); margin-bottom: 15px;">
                            Download your family data for backup or editing.
                        </p>
                        <div class="data-actions">
                            <button class="action-btn" onclick="exportJSON()">Download JSON</button>
                            <button class="action-btn" onclick="exportCSV()">Download CSV</button>
                            <button class="action-btn secondary" onclick="copyToClipboard()">Copy JSON</button>
                        </div>
                        <div class="data-actions" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(212, 175, 55, 0.2);">
                            <button class="action-btn" onclick="exportUpdatedHTML()" style="background: linear-gradient(135deg, #3498db, #2980b9); flex: 1;">
                                Download Updated HTML File
                            </button>
                        </div>
                        <p style="color: var(--gold-200); margin-top: 10px; font-size: 13px; opacity: 0.8;">
                            Note: Downloads a new HTML file with current data baked in. Upload to GitHub to make changes permanent!
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Selector Modal -->
    <div class="data-manager-modal" id="themeSelectorModal" style="display: none; visibility: hidden; opacity: 0; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 200000;">
        <div class="data-manager-content" style="max-width: 700px;">
            <div class="data-manager-header">
                <h2>🎨 Theme Selector</h2>
                <button class="data-manager-close" onclick="closeThemeSelector()">×</button>
            </div>
            <div class="data-manager-body" style="padding: 30px;">
                <p style="color: var(--gold-300); margin-bottom: 25px;">
                    Choose a color palette - changes apply instantly!
                </p>
                
                <div class="theme-grid" style="display: grid; gap: 15px;">
                    <!-- Current Theme -->
                    <div class="theme-option" onclick="applyTheme('current')" style="padding: 20px; border: 2px solid var(--gold-500); border-radius: 12px; cursor: pointer; background: rgba(244, 162, 97, 0.1);">
                        <h3 style="color: var(--gold-500); margin-bottom: 10px; font-size: 18px;">Current - Warm Modern</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 40px; height: 40px; background: #1a1a1a; border-radius: 6px; border: 1px solid #555;"></div>
                            <div style="width: 40px; height: 40px; background: #f4a261; border-radius: 6px;"></div>
                            <div style="width: 40px; height: 40px; background: #4a9eff; border-radius: 6px;"></div>
                            <div style="width: 40px; height: 40px; background: #ff6b9d; border-radius: 6px;"></div>
                        </div>
                        <p style="color: var(--gold-200); font-size: 13px;">Dark charcoal • Warm coral-gold • Bright blue & pink</p>
                    </div>
                    
                    <!-- Option 1: Forest & Earth -->
                    <div class="theme-option" onclick="applyTheme('forest')" style="padding: 20px; border: 2px solid #5a9d8e; border-radius: 12px; cursor: pointer; background: rgba(90, 157, 142, 0.1); transition: all 0.3s;">
                        <h3 style="color: #c9a86a; margin-bottom: 10px; font-size: 18px;">Forest & Earth Tones</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 40px; height: 40px; background: #1c2321; border-radius: 6px; border: 1px solid #555;"></div>
                            <div style="width: 40px; height: 40px; background: #c9a86a; border-radius: 6px;"></div>
                            <div style="width: 40px; height: 40px; background: #5a9d8e; border-radius: 6px;"></div>
                            <div style="width: 40px; height: 40px; background: #b87d6f; border-radius: 6px;"></div>
                        </div>
                        <p style="color: #d4b88f; font-size: 13px;">Natural • Calming • Traditional</p>
                    </div>
                    
                    <!-- Option 2: Ocean & Sky -->
                    <div class="theme-option" onclick="applyTheme('ocean')" style="padding: 20px; border: 2px solid #00b4d8; border-radius: 12px; cursor: pointer; background: rgba(0, 180, 216, 0.1); transition: all 0.3s;">
                        <h3 style="color: #ffc857; margin-bottom: 10px; font-size: 18px;">Ocean & Sky</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 40px; height: 40px; background: #0f1419; border-radius: 6px; border: 1px solid #555;"></div>
                            <div style="width: 40px; height: 40px; background: #ffc857; border-radius: 6px;"></div>
                            <div style="width: 40px; height: 40px; background: #00b4d8; border-radius: 6px;"></div>
                            <div style="width: 40px; height: 40px; background: #f72585; border-radius: 6px;"></div>
                        </div>
                        <p style="color: #ffd77a; font-size: 13px;">Fresh • Clean • Modern</p>
                    </div>
                    
                    <!-- Option 3: Royal Purple & Gold -->
                    <div class="theme-option" onclick="applyTheme('royal')" style="padding: 20px; border: 2px solid #daa520; border-radius: 12px; cursor: pointer; background: rgba(218, 165, 32, 0.1); transition: all 0.3s;">
                        <h3 style="color: #daa520; margin-bottom: 10px; font-size: 18px;">Royal Purple & Gold</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 40px; height: 40px; background: #1a0f2e; border-radius: 6px; border: 1px solid #555;"></div>
                            <div style="width: 40px; height: 40px; background: #daa520; border-radius: 6px;"></div>
                            <div style="width: 40px; height: 40px; background: #6c5ce7; border-radius: 6px;"></div>
                            <div style="width: 40px; height: 40px; background: #fd79a8; border-radius: 6px;"></div>
                        </div>
                        <p style="color: #e6b84f; font-size: 13px;">Elegant • Sophisticated • Regal</p>
                    </div>
                    
                    <!-- Option 4: Slate & Mint -->
                    <div class="theme-option" onclick="applyTheme('slate')" style="padding: 20px; border: 2px solid #00d9a0; border-radius: 12px; cursor: pointer; background: rgba(0, 217, 160, 0.1); transition: all 0.3s;">
                        <h3 style="color: #00d9a0; margin-bottom: 10px; font-size: 18px;">Slate & Mint</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 40px; height: 40px; background: #1e1e1e; border-radius: 6px; border: 1px solid #555;"></div>
                            <div style="width: 40px; height: 40px; background: #00d9a0; border-radius: 6px;"></div>
                            <div style="width: 40px; height: 40px; background: #4dabf7; border-radius: 6px;"></div>
                            <div style="width: 40px; height: 40px; background: #ff6b9d; border-radius: 6px;"></div>
                        </div>
                        <p style="color: #33e2b3; font-size: 13px;">Professional • Corporate • Clean</p>
                    </div>
                    
                    <!-- Option 5: Sunset Warm -->
                    <div class="theme-option" onclick="applyTheme('sunset')" style="padding: 20px; border: 2px solid #ff9a56; border-radius: 12px; cursor: pointer; background: rgba(255, 154, 86, 0.1); transition: all 0.3s;">
                        <h3 style="color: #ff9a56; margin-bottom: 10px; font-size: 18px;">Sunset Warm</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 40px; height: 40px; background: #1a1312; border-radius: 6px; border: 1px solid #555;"></div>
                            <div style="width: 40px; height: 40px; background: #ff9a56; border-radius: 6px;"></div>
                            <div style="width: 40px; height: 40px; background: #5dade2; border-radius: 6px;"></div>
                            <div style="width: 40px; height: 40px; background: #ec7063; border-radius: 6px;"></div>
                        </div>
                        <p style="color: #ffb380; font-size: 13px;">Energetic • Warm • Inviting</p>
                    </div>
                </div>
                
                <p style="color: var(--gold-200); margin-top: 25px; font-size: 13px; opacity: 0.8;">
                    💡 Your theme choice is saved automatically and persists across sessions!
                </p>
            </div>
        </div>
    </div>

</body>
</html>
